# AI模型选择分析：图表生成任务

**生成时间**: 2025-01-28  
**任务**: 从用户数据生成 ECharts 图表配置 JSON

## 任务特点分析

1. **结构化输出要求高**：必须生成符合 ECharts Option 规范的 JSON
2. **需要数据理解能力**：理解 CSV/JSON 数据结构，选择合适的图表类型
3. **Schema 验证严格**：输出必须通过 JSON Schema 校验
4. **中文支持**：图表标题、标签等需要中文
5. **成本敏感**：Edge Function 频繁调用，需要控制成本
6. **响应速度**：用户期望快速看到结果（3秒内）

## 模型对比分析

### 1. 通义千问（Qwen）- 当前使用 ✅

**优势**：
- ✅ **JSON 输出能力强**：`response_format: { type: "json_object" }` 支持好
- ✅ **成本低**：`qwen-plus` 性价比高，适合高频调用
- ✅ **中文理解好**：阿里云训练，中文场景表现优秀
- ✅ **API 稳定**：DashScope 服务稳定，国内访问速度快
- ✅ **超时控制好**：15秒超时，有重试机制

**劣势**：
- ⚠️ 复杂数据结构的理解可能不如 GPT-4
- ⚠️ 创意图表类型选择可能不够丰富

**适用场景**：✅ **推荐继续使用**
- 成本敏感的生产环境
- 需要快速响应的场景
- 主要处理中文数据

**当前配置**：
```typescript
model: "qwen-plus"  // 可升级为 qwen-max（效果更好，成本更高）
temperature: 0       // 确保输出稳定
response_format: { type: "json_object" }
```

---

### 2. GPT-4o / GPT-4 Turbo

**优势**：
- ✅ **结构化输出优秀**：JSON 模式支持完善
- ✅ **数据理解能力强**：能更好地理解复杂数据结构
- ✅ **图表类型选择智能**：能选择更合适的图表类型
- ✅ **错误处理好**：输出格式更规范，减少 Schema 校验失败

**劣势**：
- ❌ **成本高**：API 调用成本是 Qwen 的 3-5 倍
- ❌ **国内访问慢**：需要代理或使用 Azure OpenAI
- ❌ **API 限制**：可能有速率限制

**适用场景**：
- 对图表质量要求极高的场景
- 处理复杂/非结构化数据
- 预算充足的项目

**推荐配置**：
```typescript
model: "gpt-4o"  // 或 "gpt-4-turbo-preview"
temperature: 0
response_format: { type: "json_object" }
```

---

### 3. Claude 3.5 Sonnet

**优势**：
- ✅ **结构化输出优秀**：JSON 格式规范
- ✅ **数据理解能力强**：擅长分析复杂数据
- ✅ **代码生成好**：ECharts 配置生成准确

**劣势**：
- ❌ **成本高**：与 GPT-4 相当
- ❌ **国内访问困难**：需要代理
- ❌ **API 限制**：可能有速率限制

**适用场景**：
- 需要高质量图表配置
- 处理复杂数据分析场景

---

### 4. 文心一言（ERNIE）

**优势**：
- ✅ **中文支持好**：百度训练，中文理解优秀
- ✅ **国内访问快**：百度云服务稳定
- ✅ **成本适中**：比 GPT-4 便宜

**劣势**：
- ⚠️ JSON 输出能力可能不如 Qwen
- ⚠️ 需要适配 API 接口

**适用场景**：
- 主要处理中文数据
- 需要国内稳定服务

---

### 5. 智谱 GLM-4

**优势**：
- ✅ **中文支持好**：清华训练
- ✅ **成本适中**：比 GPT-4 便宜
- ✅ **API 稳定**：国内服务

**劣势**：
- ⚠️ JSON 输出能力待验证
- ⚠️ 图表生成经验较少

---

## 推荐方案

### 方案一：继续使用 Qwen（推荐）✅

**理由**：
1. 当前已实现，无需改动
2. 成本低，适合生产环境
3. JSON 输出能力满足需求
4. 国内访问速度快

**优化建议**：
- 如果效果不够好，可升级为 `qwen-max`
- 优化 System Prompt，提供更多 ECharts 示例
- 增加 Few-shot 示例，提升输出质量

### 方案二：Qwen + GPT-4o 混合（高级）

**策略**：
- 默认使用 Qwen（低成本）
- 复杂数据或 Qwen 失败时降级到 GPT-4o
- 根据数据复杂度自动选择

**实现**：
```typescript
// 伪代码
if (dataComplexity > threshold || qwenFailed) {
  return await callGPT4o(data);
} else {
  return await callQwen(data);
}
```

### 方案三：多模型 A/B 测试

**策略**：
- 同时调用多个模型
- 选择第一个成功的响应
- 记录各模型成功率，优化选择

---

## 当前任务优化建议

### 1. 优化 System Prompt

```typescript
const systemPrompt = `你是数据可视化专家。依据用户提供的数据生成严格符合 ECharts Option 的 JSON；不要输出任何非 JSON 文本。

要求：
1) 自动选择合适图表类型（如 bar/line/pie/scatter/radar），
2) 生成完整配置（title、legend、tooltip、xAxis/yAxis、series、grid），
3) 文本使用简体中文，
4) 数据映射正确（确保 series.data 与 xAxis.data 对应），
5) 若输入信息不足，合理假设并给出可渲染的配置。

示例：
输入：{"月份":["1月","2月","3月"],"销售额":[120,200,150]}
输出：{
  "title": {"text": "月度销售额"},
  "xAxis": {"type": "category", "data": ["1月","2月","3月"]},
  "yAxis": {"type": "value"},
  "series": [{"type": "bar", "data": [120,200,150]}]
}`;
```

### 2. 增加 Few-shot 示例

在 User Message 中添加 1-2 个示例，提升输出质量。

### 3. 模型升级路径

```
qwen-plus (当前) 
  ↓ 如果效果不够好
qwen-max (升级)
  ↓ 如果成本可接受且需要更好效果
GPT-4o (高级)
```

---

## 成本对比（估算）

| 模型 | 每1K tokens | 月调用1000次（平均1K tokens/次） |
|------|-------------|--------------------------------|
| qwen-plus | ¥0.008 | ¥8 |
| qwen-max | ¥0.02 | ¥20 |
| GPT-4o | ¥0.03 | ¥30 |
| Claude 3.5 Sonnet | ¥0.03 | ¥30 |

---

## 结论

**当前推荐**：继续使用 **通义千问（Qwen）**，原因：
1. ✅ 成本低，适合生产环境
2. ✅ JSON 输出能力满足需求
3. ✅ 国内访问速度快
4. ✅ 已实现，无需改动

**优化方向**：
1. 优化 System Prompt，添加更多示例
2. 如果效果不够好，升级到 `qwen-max`
3. 监控成功率，如果低于 95%，考虑引入 GPT-4o 作为降级方案

**未来扩展**：
- 如果预算充足且需要更高质量，可考虑 GPT-4o
- 如果主要处理中文数据，可考虑文心一言作为备选

