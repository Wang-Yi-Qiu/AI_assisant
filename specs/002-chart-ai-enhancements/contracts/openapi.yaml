openapi: 3.0.3
info:
  title: AI Chart Enhancement API
  version: 2.0.0
  description: |
    图表增强与AI洞察功能的API契约。
    包括图表重新生成、AI洞察生成等新增端点。
paths:
  /functions/v1/generate_chart:
    post:
      x-operation-id: generate_chart_qwen
      description: |
        生成 ECharts 图表配置（Qwen 驱动）。实现文件 `supabase/functions/generate_chart_qwen/index.ts`。
        本特性中用于"图表重新生成"功能，复用现有端点。
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: apikey
          required: true
          schema:
            type: string
          description: Supabase anon key，与 Authorization 一致，用于通过平台网关校验。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../001-ai-chart-mvp/contracts/schemas/userData.schema.json'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '../001-ai-chart-mvp/contracts/schemas/chartConfig.schema.json'
        '401':
          description: Unauthorized (缺失或无效 anon key)
        '404':
          description: Not Found (函数未部署或路径错误)
        '504':
          description: Gateway Timeout (下游模型/网络超时，可能返回回退模板)

  /functions/v1/generate_insight:
    post:
      x-operation-id: generate_insight
      description: |
        生成AI洞察（Qwen 驱动）。实现文件 `supabase/functions/generate_insight/index.ts`。
        支持两种洞察类型：图表数据洞察（chart）和专注数据洞察（focus）。
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: apikey
          required: true
          schema:
            type: string
          description: Supabase anon key，与 Authorization 一致，用于通过平台网关校验。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                type:
                  type: string
                  enum: [chart, focus]
                  description: 洞察类型
                data:
                  oneOf:
                    - type: object
                      description: 图表洞察数据（图表配置或原始数据）
                      properties:
                        chartConfig:
                          $ref: '../001-ai-chart-mvp/contracts/schemas/chartConfig.schema.json'
                        rawData:
                          type: string
                          description: 原始数据（JSON/CSV格式）
                    - type: object
                      description: 专注洞察数据
                      properties:
                        userId:
                          type: string
                          format: uuid
                          description: 用户ID
                        period:
                          type: string
                          enum: [week, month, year]
                          description: 分析周期
                        periodStart:
                          type: string
                          format: date
                          description: 周期开始日期
                        periodEnd:
                          type: string
                          format: date
                          description: 周期结束日期
                        focusData:
                          type: object
                          description: 专注时间统计数据
              required:
                - type
                - data
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: './schemas/insightSchema.json'
        '400':
          description: Bad Request (无效的请求参数或数据格式)
        '401':
          description: Unauthorized (缺失或无效 anon key)
        '404':
          description: Not Found (函数未部署或路径错误)
        '504':
          description: Gateway Timeout (AI服务超时，返回降级提示)
        '500':
          description: Internal Server Error (AI服务错误)

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer

