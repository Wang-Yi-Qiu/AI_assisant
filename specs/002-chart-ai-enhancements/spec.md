# Feature Specification: 图表增强与AI洞察功能

**Feature Branch**: `002-chart-ai-enhancements`  
**Created**: 2025-01-28  
**Status**: Ready  
**Input**: User description: "@pr.md"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 样本数据快速体验 (Priority: P1)

作为新用户，我可以点击"使用样本数据"按钮，一键加载预设的示例数据集，快速体验图表生成功能，无需手动输入或上传文件。

**Why this priority**: 降低新用户使用门槛，提供快速上手体验，展示应用核心价值。

**Independent Test**: 仅实现该功能即可让用户通过一次点击完成数据加载和图表生成，具备独立演示价值。

**Acceptance Scenarios**:

1. **Given** 用户在首页，**When** 点击"使用样本数据"按钮，**Then** 输入框自动填充预设的示例数据（JSON或CSV格式）。
2. **Given** 样本数据已加载到输入框，**When** 用户点击"生成图表"，**Then** 系统成功生成并显示示例图表。
3. **Given** 用户在不同设备上，**When** 点击"使用样本数据"，**Then** 所有支持的设备类型都能正常加载和显示样本数据。

---

### User Story 2 - 图表重新生成 (Priority: P1)

作为用户，我可以对当前显示的图表点击"重新生成"按钮，基于相同数据让AI重新生成不同风格的图表配置，获得更多可视化选择。

**Why this priority**: 提供用户对图表生成结果的控制权，满足不同场景下的可视化需求。

**Independent Test**: 仅实现该功能即可让用户在不改变数据的情况下获得新的图表配置，具备独立价值。

**Acceptance Scenarios**:

1. **Given** 图表页面已显示一个图表，**When** 用户点击"重新生成"按钮，**Then** 系统基于当前数据重新调用AI生成新的图表配置并更新显示。
2. **Given** 重新生成过程中，**When** AI服务响应，**Then** 显示加载状态，完成后平滑切换到新图表。
3. **Given** 重新生成失败或超时，**When** 系统检测到错误，**Then** 显示友好错误提示，保留原图表显示。

---

### User Story 3 - 图表类型切换 (Priority: P2)

作为用户，我可以点击"更改类型"按钮，手动切换当前图表的类型（如折线图、柱状图、饼图等），快速尝试不同的可视化方式。

**Why this priority**: 提供用户对图表类型的直接控制，无需重新生成即可快速切换可视化方式。

**Independent Test**: 仅实现该功能即可让用户在不重新调用AI的情况下切换图表类型，具备独立价值。

**Acceptance Scenarios**:

1. **Given** 图表页面显示一个折线图，**When** 用户点击"更改类型"并选择"柱状图"，**Then** 图表立即切换为柱状图显示，数据保持不变。
2. **Given** 用户选择图表类型，**When** 系统切换类型，**Then** 图表配置正确更新，图表平滑过渡显示。
3. **Given** 当前数据不适合某种图表类型，**When** 用户尝试切换，**Then** 系统提示该类型不适用或自动选择最合适的类型。

---

### User Story 4 - 图表数据AI洞察 (Priority: P2)

作为用户，我可以在图表预览页面查看"AI 洞察"部分，了解AI对当前图表数据的智能分析和建议，帮助我更好地理解数据趋势和关键信息。

**Why this priority**: 增强用户对数据的理解，提供智能化的数据分析能力，提升应用价值。

**Independent Test**: 仅实现该功能即可让用户获得数据洞察，具备独立价值。

**Acceptance Scenarios**:

1. **Given** 图表页面显示一个图表，**When** 用户查看"AI 洞察"部分，**Then** 显示AI生成的数据分析文本，包括：
   - 趋势分析：数据的变化趋势（上升、下降、波动等）
   - 关键点：数据中的最大值、最小值、异常值等关键信息
   - 建议：基于数据分析的操作建议（如"建议关注X月的异常下降"）
2. **Given** 用户首次查看洞察，**When** 系统调用AI服务，**Then** 显示加载状态，完成后展示洞察内容。
3. **Given** AI洞察生成失败，**When** 系统检测到错误，**Then** 显示友好提示，不影响图表正常显示。

---

### User Story 5 - 专注数据AI洞察 (Priority: P3)

作为用户，我可以在专注进度统计页面点击"AI 洞察"按钮，获得基于我的专注时间数据的智能分析报告和建议，帮助我优化工作习惯。

**Why this priority**: 为专注管理功能提供智能化分析能力，提升用户体验和价值。

**Independent Test**: 仅实现该功能即可让用户获得专注数据分析，具备独立价值。

**Acceptance Scenarios**:

1. **Given** 用户在专注进度统计页面，**When** 点击"总专注时间"部分的"AI 洞察"按钮，**Then** 显示基于专注数据的AI分析报告。
2. **Given** 用户查看洞察报告，**When** 系统生成分析，**Then** 报告包含专注趋势、最佳时段、改进建议等内容。
3. **Given** 用户没有足够的专注数据，**When** 尝试查看洞察，**Then** 系统提示需要更多数据或显示基础统计信息。

---

### Edge Cases

- **样本数据加载失败**：
  - 文件不存在：显示"样本数据文件不存在，请手动输入数据"提示，允许用户手动输入或上传文件
  - JSON格式错误：显示"样本数据格式错误，请手动输入数据"提示，允许用户手动输入
  - 数据为空或无效：显示"样本数据无效，请手动输入数据"提示，允许用户手动输入
  - 所有错误提示格式：使用Toast提示（2秒自动消失）+ 输入框下方红色文字提示（持续显示直到用户操作）

- **重新生成时网络中断**：
  - 检测到网络错误：保留原图表显示，显示"网络连接失败，请检查网络后重试"提示，提供重试按钮
  - 服务超时：保留原图表显示，显示"服务响应超时，请稍后重试"提示，提供重试按钮
  - 重试机制：用户点击重试按钮后，重新调用AI服务生成图表

- **图表类型切换时数据不兼容**：
  - 数据维度不足（如散点图需要2个数值维度，但只有1个）：显示"当前数据不适合该图表类型，已自动选择最合适的类型"提示，自动切换到兼容的类型
  - 数据点数量不足（如折线图需要至少2个数据点，但只有1个）：显示"当前数据点数量不足，已自动选择最合适的类型"提示，自动切换到兼容的类型
  - 所有类型都不兼容：显示"当前数据无法切换图表类型，请使用重新生成功能"提示，保留当前图表类型
  - 验收标准：系统应自动选择最合适的类型或明确提示用户，保留当前图表显示，不出现错误或崩溃

- **AI洞察服务不可用**：
  - 服务超时（>5秒）：显示"AI洞察生成超时，请稍后重试"Toast提示（2秒），不影响图表正常显示
  - 服务错误（网络错误、服务不可用等）：显示"AI洞察暂时不可用，请稍后重试"Toast提示（2秒），不影响图表正常显示
  - 降级时图表生成、类型切换等主要功能正常使用
  - 用户可以通过刷新页面或重新打开洞察区域重新尝试
  - 验收标准：服务超时和错误都应显示明确的降级提示，主要功能不受影响，用户可以重试

- **样本数据格式错误**：
  - JSON解析失败：显示"样本数据格式错误，请手动输入数据"提示，允许用户手动输入
  - 数据字段缺失：显示"样本数据不完整，请手动输入数据"提示，允许用户手动输入
  - 文件损坏或无效JSON格式：显示"样本数据文件损坏，请手动输入数据"提示，允许用户手动输入
  - 验收标准：所有错误情况都应显示明确的错误提示，允许用户手动输入数据，不影响应用正常使用

- **多设备适配**：
  - TV/车机：按钮布局支持焦点导航，使用方向键和确认键操作，焦点指示器清晰可见
  - 可穿戴：按钮布局精简，减少显示数量，支持手势操作，关键功能≤2步完成
  - 所有设备：按钮布局和交互方式需适配，确保功能可用性

- **并发用户交互场景**：
  - 快速连续点击"重新生成"按钮：仅处理最后一次点击，忽略中间请求，显示加载状态
  - 同时切换图表类型：仅处理最后一次选择，忽略中间选择，立即响应
  - 在AI洞察加载过程中切换图表类型：取消洞察请求，立即切换图表类型

- **部分失败场景**：
  - 部分样本数据加载成功，部分失败：显示已加载的数据，对失败的数据显示错误提示
  - 图表重新生成成功但AI洞察生成失败：显示新图表，洞察区域显示降级提示
  - 图表类型切换成功但数据验证部分失败：显示切换后的图表，显示数据验证警告提示

- **图表重新生成时原始数据不可用**：
  - 原始数据已从内存中清除：从当前显示的图表配置中提取数据，用于重新生成
  - 当前图表配置无效：显示"无法重新生成，请重新输入数据"提示，引导用户返回首页

- **资源受限设备的样本数据加载**：
  - 设备存储空间不足：显示"存储空间不足，请清理空间后重试"提示，允许用户手动输入数据
  - 设备内存不足：显示"内存不足，请关闭其他应用后重试"提示，允许用户手动输入数据
  - 加载超时（>3秒）：显示"加载超时，请手动输入数据"提示，允许用户手动输入
  - 验收标准：所有资源受限情况都应显示明确的错误提示，允许用户手动输入数据，不影响应用正常使用

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在首页提供"使用样本数据"按钮，点击后自动加载预设的示例数据集到输入框。
- **FR-002**: 系统必须提供5种不同类型的样本数据集，具体包括：
  - 月度销售数据（sales-monthly.json）：适合折线图和柱状图
  - 用户增长数据（users-growth.json）：适合折线图和柱状图
  - 产品分类占比数据（products-category.json）：适合饼图
  - 销售与利润关系数据（sales-profit.json）：适合散点图
  - 时间序列数据（timeseries-daily.json）：适合折线图
  确保用户能体验不同的图表类型。
- **FR-003**: 系统必须在图表预览页面提供"重新生成"按钮，允许用户基于当前数据重新调用AI生成图表配置。
- **FR-004**: 系统必须在图表预览页面提供"更改类型"按钮，允许用户手动切换图表类型。支持的图表类型包括：
  - 折线图（line）：适合展示趋势和连续性数据
  - 柱状图（bar）：适合展示分类数据对比
  - 饼图（pie）：适合展示占比和比例数据
  - 散点图（scatter）：适合展示两个变量之间的关系
  系统会根据当前数据自动判断哪些类型可用，不兼容的类型将被禁用或提示用户。
- **FR-005**: 系统必须在图表预览页面显示"AI 洞察"部分，展示AI对当前图表数据的智能分析和建议。
- **FR-006**: 系统必须在专注进度统计页面的"总专注时间"部分提供"AI 洞察"按钮，生成基于专注数据的分析报告。
- **FR-007**: 所有AI洞察功能必须在服务不可用时优雅降级，具体行为包括：
  - 服务超时（>5秒）：显示"AI洞察生成超时，请稍后重试"提示，保留图表正常显示
  - 服务错误（网络错误、服务不可用等）：显示"AI洞察暂时不可用，请稍后重试"提示，保留图表正常显示
  - 降级时不影响图表生成、类型切换等主要功能的使用
  - 用户可以通过重试按钮或刷新页面重新尝试获取洞察
- **FR-008**: 所有新增按钮和功能必须支持多设备适配（phone、tablet、2in1、TV、wearable、car、smartVision）。
- **FR-009**: 图表类型切换必须保持数据完整性，仅修改可视化方式，不改变数据本身。
  - 数据完整性定义：保持原始数据的所有字段和值不变，仅修改 `series[0].type` 字段
  - 数据保持不变：X轴/Y轴数据、数据点数量、数据字段名称等均保持不变
  - 仅修改内容：图表类型（line/bar/pie/scatter）、图表渲染方式、视觉呈现效果
- **FR-010**: 重新生成功能必须显示明确的加载状态，让用户了解操作进度。
  - 视觉指示器：显示加载动画（如旋转图标或进度条），覆盖在图表区域或按钮上
  - 状态提示：显示"正在重新生成图表..."文字提示
  - 用户反馈：按钮状态变为禁用（disabled），防止重复点击
  - 完成反馈：加载完成后，新图表平滑切换显示，加载动画消失

### Non-Functional Requirements

- **NFR-001**: 样本数据加载时间应小于1秒（从点击按钮到输入框填充完成的时间，在正常设备上测量，P95 ≤ 1秒），提供即时反馈。
- **NFR-002**: 图表重新生成响应时间应遵循现有AI服务SLO（从点击"重新生成"按钮到新图表显示完成的时间，P95 ≤ 3秒）。
- **NFR-003**: 图表类型切换应即时响应，响应时间≤500ms（从选择新类型到图表重新渲染完成的时间，P95 ≤ 500ms），无感知延迟。
- **NFR-004**: AI洞察生成应在5秒内完成（从请求洞察到显示洞察内容的时间，P95 ≤ 5秒），超时则显示降级提示（显示"AI洞察暂时不可用，请稍后重试"的友好提示，不影响图表正常显示）。
- **NFR-005**: 所有新增功能必须遵循项目宪法原则（规范先行、云端优先、安全合规）。

### Supported Devices & Interaction Differences

- **设备矩阵**: phone, tablet, 2in1, tv, wearable, car, smartVision
- **布局适配**: 
  - 手机/平板：按钮正常显示，支持触控操作
  - TV/车机：按钮需支持焦点导航，使用方向键和确认键操作
    - 焦点导航顺序：从左到右、从上到下（Tab键顺序）
    - 焦点指示器：清晰的视觉反馈（如高亮边框、阴影效果），焦点元素明显区别于非焦点元素
    - 导航键：方向键（上下左右）移动焦点，确认键（Enter/OK）触发操作，返回键（Back）返回上一级
  - 可穿戴：按钮布局精简，减少显示数量，支持手势操作
- **能力降级**:
  - AI洞察功能在服务不可用时显示友好提示
  - 图表类型切换在所有设备上均支持
  - 样本数据加载在所有设备上均支持

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 90%的新用户能在首次使用时通过"样本数据"功能在2分钟内完成首次图表生成。
  - 测量方法：记录新用户从打开应用到完成首次图表生成的时间，统计90分位数
  - 测试条件：在正常网络环境下，使用标准设备（phone）进行测试

- **SC-002**: 图表重新生成成功率≥95%，平均响应时间≤3秒（P95）。
  - 测量方法：记录所有重新生成请求的成功率和响应时间，计算P95分位数
  - 测试条件：在正常网络环境下，使用不同设备类型进行测试，至少100次请求

- **SC-003**: 图表类型切换响应时间≤500ms，用户满意度≥85%。
  - 测量方法：记录类型切换操作的响应时间（P95），并通过用户调研问卷评估满意度
  - 测试条件：在正常设备性能下，使用不同图表类型进行测试，至少50次切换操作

- **SC-004**: AI洞察功能可用性≥90%，生成成功率≥80%。
  - 测量方法：可用性 = (总时间 - 不可用时间) / 总时间 × 100%，成功率 = 成功请求数 / 总请求数 × 100%
  - 测试条件：在正常网络环境下，连续运行24小时，记录所有洞察请求的成功和失败情况

- **SC-005**: 所有新增功能在多设备测试中通过率≥95%，无严重适配问题。
  - 测量方法：在7种设备类型（phone、tablet、2in1、tv、wearable、car、smartVision）上测试所有新增功能，统计通过率
  - 测试条件：使用标准测试用例，覆盖所有用户场景，严重适配问题定义为功能完全不可用或严重影响用户体验

### Qualitative Measures

- **用户反馈评估方法**：
  - 通过用户调研问卷（5分制Likert量表）评估用户满意度
  - 收集用户反馈意见，分析关键词和情感倾向
  - 评估指标：样本数据功能是否降低了使用门槛（≥4.0分）、控制感是否提升（≥4.0分）、AI洞察是否有帮助（≥4.0分）
- **控制感评估方法**：
  - 通过用户行为数据分析：重新生成和类型切换功能的使用频率
  - 通过用户访谈了解用户对可视化结果控制感的感知
  - 评估指标：用户认为对图表结果有控制感（≥85%用户同意）
- **数据分析价值评估方法**：
  - 通过用户调研问卷评估AI洞察功能的价值感知
  - 通过用户行为数据分析：AI洞察功能的查看率和停留时间
  - 评估指标：用户认为AI洞察提供了有价值的数据分析（≥80%用户同意）

## Key Entities *(include if feature involves data)*

- **SampleDataset**: 代表预设的样本数据集；关键属性：id（唯一标识）、name（显示名称）、description（描述文本）、filePath（rawfile资源路径）、data（JSON格式数据）、chartType（推荐图表类型：line/bar/pie/scatter）、category（数据类别：sales/users/products/timeseries）。
- **ChartInsight**: 代表AI生成的图表数据洞察；关键属性：chartId、insightText、generatedAt、confidence。
- **FocusInsight**: 代表AI生成的专注数据洞察；关键属性：userId、insightText、period（周/月/年）、generatedAt。

## Dependencies

- 依赖现有的AI服务（Edge Function `generate_chart_qwen`）用于图表重新生成
- 需要新增AI洞察服务（新建独立 Edge Function `generate_insight`，与 `generate_chart_qwen` 分离，支持图表和专注两种洞察类型）
- 依赖现有的图表渲染能力（ChartPage.ets）
- 依赖现有的专注数据统计能力（ProgressPage.ets）

## Assumptions

- 样本数据将存储在本地资源文件中，不占用云端存储
- AI洞察功能可以复用现有的通义千问模型，通过调整prompt实现
- 图表类型切换仅修改series[0].type，不涉及数据转换
- 用户已熟悉基本的图表类型概念（折线图、柱状图等）
- 多设备适配将使用现有的deviceAdapter工具

## Clarifications Needed

以下问题需要在规划阶段明确，以确保实现方案的正确性：

### Question 1: AI洞察响应格式

**Context**: AI洞察功能需要返回文本格式的分析结果，但当前项目只有图表配置的Schema定义。

**What we need to know**: AI洞察功能的响应格式是否需要定义新的Schema，还是复用现有的chartConfig格式？

**Suggested Answers**:

| Option | Answer | Implications |
|--------|--------|--------------|
| A | 定义新的insightSchema.json，包含text、confidence、suggestions等字段 | 更规范，便于后续扩展，但需要新增Schema文件 |
| B | 复用chartConfig格式，将洞察文本放在title或tooltip中 | 实现简单，但不符合数据语义，不利于扩展 |
| C | 使用简单的文本响应，不定义Schema | 最快实现，但缺乏结构化和验证 |

**Your choice**: **A** - 定义新的insightSchema.json，包含text、confidence、suggestions等字段

**Rationale**: 符合项目宪法"规范先行"原则，确保API契约和数据结构的规范性。定义独立的Schema便于后续扩展（如支持多语言洞察、结构化建议等），同时便于进行Schema验证和类型检查。

---

### Question 2: 样本数据集配置方式

**Context**: 样本数据功能需要提供预设的示例数据集供用户快速体验。

**What we need to know**: 样本数据集的数量和类型是否需要可配置，还是固定为预设的几种？

**Suggested Answers**:

| Option | Answer | Implications |
|--------|--------|--------------|
| A | 固定3-5种预设样本数据，存储在本地资源文件 | 实现简单，加载快速，但扩展性差 |
| B | 可配置的样本数据列表，支持从配置文件或云端加载 | 灵活可扩展，但增加复杂度 |
| C | 固定样本数据，但支持后续通过更新添加新样本 | 平衡实现复杂度和扩展性 |

**Your choice**: **A** - 固定3-5种预设样本数据，存储在本地资源文件

**Rationale**: 符合MVP原则，快速实现核心功能。固定预设数据实现简单、加载快速，能够满足新用户快速体验的需求。后续如需扩展，可以通过应用更新添加新的样本数据，无需复杂的配置系统。

---

### Question 3: 图表类型切换范围

**Context**: 图表类型切换功能允许用户手动切换可视化方式。

**What we need to know**: 图表类型切换是否需要支持所有ECharts支持的图表类型，还是仅支持常用类型？

**Suggested Answers**:

| Option | Answer | Implications |
|--------|--------|--------------|
| A | 仅支持常用类型（折线图、柱状图、饼图、散点图） | 实现简单，用户界面清晰，覆盖80%使用场景 |
| B | 支持所有ECharts基础图表类型（约15种） | 功能完整，但界面复杂，需要更好的UI设计 |
| C | 支持常用类型，但提供"更多类型"入口展开完整列表 | 平衡易用性和功能完整性 |

**Your choice**: **A** - 仅支持常用类型（折线图、柱状图、饼图、散点图）

**Rationale**: 符合MVP原则，覆盖80%的使用场景。常用类型界面清晰、用户易于理解，能够满足大部分数据可视化需求。后续可以根据用户反馈和需求扩展更多图表类型，或通过"更多类型"入口提供完整列表。

