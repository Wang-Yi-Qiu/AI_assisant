# Quickstart — 图表增强与AI洞察功能

## 前置

- 准备演示账户；应用已安装到设备；已配置环境变量于服务端（不要在前端暴露密钥）
- 确保 Edge Function `generate_insight` 已部署到 Supabase
- 确保样本数据文件已放置在 `entry/src/main/resources/rawfile/sample-data/` 目录

## 功能演示步骤

### 1. 样本数据快速体验

1. 打开应用，进入首页（HomePage）
2. 点击"使用样本数据"按钮
3. 观察输入框自动填充预设的示例数据（期望 <1秒）
4. 点击"生成图表"
5. 观察图表成功生成并显示（期望 3秒内）

**验证点**:
- ✅ 样本数据加载时间 <1秒
- ✅ 数据格式正确，可以成功生成图表
- ✅ 不同设备上都能正常加载

---

### 2. 图表重新生成

1. 在图表预览页面（ChartPage），查看当前图表
2. 点击"重新生成"按钮
3. 观察加载状态提示（期望显示加载动画）
4. 等待AI重新生成（期望 ≤3秒，P95）
5. 观察新图表平滑切换显示

**验证点**:
- ✅ 重新生成响应时间 ≤3秒（P95）
- ✅ 新图表配置与之前不同（风格/颜色/布局等）
- ✅ 失败时显示友好错误提示，保留原图表

---

### 3. 图表类型切换

1. 在图表预览页面，查看当前图表（如折线图）
2. 点击"更改类型"按钮
3. 选择新的图表类型（如柱状图）
4. 观察图表立即切换为新类型（期望 ≤500ms）
5. 验证数据保持不变，仅可视化方式改变

**验证点**:
- ✅ 类型切换响应时间 ≤500ms
- ✅ 数据完整性保持，仅 series[0].type 改变
- ✅ 不兼容类型时显示友好提示
- ✅ 图表平滑过渡，无闪烁

---

### 4. 图表数据AI洞察

1. 在图表预览页面，查看当前图表
2. 滚动到"AI 洞察"部分（或点击展开按钮）
3. 观察洞察内容加载（首次查看时）
4. 等待AI生成洞察（期望 ≤5秒）
5. 查看洞察文本，包括趋势分析、关键点、建议等

**验证点**:
- ✅ 洞察生成时间 ≤5秒
- ✅ 洞察内容包含有价值的信息（趋势、关键点、建议）
- ✅ 服务不可用时显示降级提示，不影响图表显示
- ✅ 缓存生效时，再次查看即时显示（无需重新生成）

---

### 5. 专注数据AI洞察

1. 进入专注进度统计页面（HistoryPage 或 ProgressPage）
2. 查看"总专注时间"部分
3. 点击"AI 洞察"按钮
4. 等待AI生成专注数据分析（期望 ≤5秒）
5. 查看洞察报告，包括专注趋势、最佳时段、改进建议等

**验证点**:
- ✅ 洞察生成时间 ≤5秒
- ✅ 报告包含专注趋势、最佳时段、改进建议等内容
- ✅ 数据不足时显示友好提示或基础统计信息
- ✅ 服务不可用时显示降级提示

---

## 多设备验证

### Phone/Tablet
- ✅ 所有按钮正常显示，支持触控操作
- ✅ 布局适配不同屏幕尺寸
- ✅ 样本数据加载和类型切换响应快速

### TV/车机
- ✅ 按钮支持焦点导航，使用方向键和确认键操作
- ✅ 焦点顺序合理，无"无焦点可达"状态
- ✅ 返回键行为符合预期

### 可穿戴设备
- ✅ 按钮布局精简，减少显示数量
- ✅ 支持手势操作
- ✅ 页面无溢出，关键任务≤2步完成

### 2in1设备
- ✅ 支持横竖屏切换
- ✅ 窗口变化时布局稳定，无截断
- ✅ 状态保持正确

---

## 鉴权与配置

### 前端配置
- 前端以 `Authorization: Bearer <anon key>` 与 `apikey: <anon key>` 调用 Edge Function
- URL 来自 `getSupabaseUrl()` + `/functions/v1/generate_insight`
- AppScope/构建变量已注入 `SUPABASE_URL`、`SUPABASE_ANON_KEY`
- 不要在代码中硬编码密钥

### 样本数据配置
- 样本数据文件存储在 `entry/src/main/resources/rawfile/sample-data/`
- 在代码中定义样本数据列表（`sampleDataManager.ets`）
- 文件路径相对于 rawfile 目录

---

## 期望结果

### 性能指标
- ✅ 样本数据加载：<1秒
- ✅ 图表重新生成：P95 ≤3秒，成功率≥95%
- ✅ 图表类型切换：≤500ms，用户满意度≥85%
- ✅ AI洞察生成：≤5秒，可用性≥90%，成功率≥80%

### 功能完整性
- ✅ 所有新增功能在多设备测试中通过率≥95%
- ✅ 90%的新用户能在首次使用时通过"样本数据"功能在2分钟内完成首次图表生成
- ✅ 错误处理和降级策略正常工作

---

## 故障排查

### 样本数据加载失败
- **症状**: 点击"使用样本数据"后无反应或显示错误
- **排查**:
  1. 检查 rawfile 资源文件是否存在
  2. 检查文件路径是否正确
  3. 检查 JSON 格式是否有效
- **解决**: 显示友好错误提示，允许用户手动输入或上传文件

### 重新生成超时
- **症状**: 点击"重新生成"后长时间无响应
- **排查**:
  1. 检查网络连接
  2. 检查 Edge Function 是否正常部署
  3. 检查 AI 服务是否可用
- **解决**: 显示超时提示，保留原图表，允许重试

### 类型切换不兼容
- **症状**: 切换图表类型后显示错误或数据异常
- **排查**:
  1. 检查数据维度是否满足新类型要求
  2. 检查数据点数量是否足够
- **解决**: 显示友好提示，自动选择合适类型或保留当前类型

### AI洞察服务不可用
- **症状**: 查看AI洞察时显示错误或超时
- **排查**:
  1. 检查 Edge Function `generate_insight` 是否部署
  2. 检查 AI 服务是否可用
  3. 检查网络连接
- **解决**: 显示降级提示，不影响图表正常显示

### 401 未授权
- **症状**: API 调用返回 401 错误
- **排查**:
  1. 检查 anon key 是否注入
  2. 检查请求头是否包含 `Authorization` 和 `apikey`
- **解决**: 确认配置正确，重新登录

### 404 函数未找到
- **症状**: API 调用返回 404 错误
- **排查**:
  1. 检查函数是否已部署
  2. 检查路径是否为 `/functions/v1/generate_insight`
- **解决**: 部署函数或检查路径配置

### 504 超时
- **症状**: AI洞察生成超时
- **排查**:
  1. 检查 AI 服务响应时间
  2. 检查网络延迟
- **解决**: 显示超时提示，允许重试；考虑增加缓存策略

---

## 度量方法（性能与观测）

### 客户端埋点
- `utils/metrics.ets` 提供 `startTimer/endTimer` 与 `newRequestId`
- 在关键路径输出结构化日志：
  ```json
  {
    "action": "sample_data_load",
    "duration": 0.8,
    "requestId": "...",
    "ok": true
  }
  {
    "action": "chart_regenerate",
    "duration": 2.5,
    "requestId": "...",
    "ok": true
  }
  {
    "action": "chart_type_switch",
    "duration": 0.3,
    "requestId": "...",
    "ok": true
  }
  {
    "action": "insight_generate",
    "type": "chart",
    "duration": 4.2,
    "requestId": "...",
    "ok": true
  }
  ```

### 指标采集
- 记录各功能的 P95 响应时间
- 记录成功率（样本数据加载、重新生成、类型切换、AI洞察）
- 记录多设备适配通过率
- 在 PR 中粘贴一次演示日志样例与 P95 粗略统计

### 用户反馈
- 收集用户对样本数据功能的反馈（是否降低了使用门槛）
- 收集用户对重新生成和类型切换功能的反馈（是否提升了控制感）
- 收集用户对AI洞察功能的反馈（是否提供了有价值的数据分析）

