<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECharts 图表</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: transparent; /* 透明背景，适配深色主题 */
            color: #ffffff; /* 白色文字，适配深色主题 */
        }

        #chart-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background-color: transparent; /* 透明背景 */
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 14px;
            color: #ffffff; /* 白色文字，适配深色主题 */
            background-color: rgba(0, 0, 0, 0.7); /* 半透明背景提高可读性 */
            padding: 20px;
            border-radius: 8px;
            backdrop-filter: blur(4px);
        }

        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 14px;
            color: #ff6b6b; /* 更柔和的红色，适配深色主题 */
            background-color: rgba(0, 0, 0, 0.8); /* 更深的背景 */
            padding: 20px;
            border-radius: 8px;
            max-width: 80%;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 107, 107, 0.3); /* 添加边框突出错误状态 */
        }

        /* 针对深色主题的图表样式优化 */
        .chart-container-dark {
            background-color: transparent !important;
        }

        /* 加载动画 */
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #ffffff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="chart-container" class="chart-container-dark">
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            正在初始化图表...
        </div>
    </div>

    <script>
        let chart = null;
        let isInitialized = false;

        // 初始化图表 - 增强版本，支持深色主题和详细日志
        function initChart() {
            try {
                console.log('========== 开始初始化 ECharts ==========');
                console.log('container 元素:', document.getElementById('chart-container'));
                console.log('ECharts 库:', typeof echarts);

                const container = document.getElementById('chart-container');
                if (!container) {
                    throw new Error('找不到图表容器元素');
                }

                // 使用深色主题初始化
                chart = echarts.init(container, 'dark');
                isInitialized = true;

                // 移除加载提示
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.style.display = 'none';
                    console.log('已移除加载提示');
                }

                console.log('✅ ECharts 初始化成功（深色主题）');
                return true;
            } catch (error) {
                console.error('❌ ECharts 初始化失败:', error);
                console.error('错误详情:', error.message, error.stack);
                showError('图表初始化失败: ' + error.message);
                return false;
            }
        }

        // 设置图表配置 - 增强版本，支持深色主题和详细错误处理
        function setChartOption(option) {
            console.log('========== setChartOption 开始执行 ==========');
            console.log('option 类型:', typeof option);
            console.log('option 内容:', option ? JSON.stringify(option).substring(0, 300) + '...' : 'null');

            try {
                // 显示加载状态
                showLoading('正在生成图表...');

                // 确保图表已初始化
                if (!isInitialized) {
                    console.log('图表未初始化，开始初始化...');
                    if (!initChart()) {
                        console.error('图表初始化失败');
                        return false;
                    }
                }

                // 验证配置
                if (!option) {
                    console.error('图表配置为空');
                    showError('图表配置为空');
                    return false;
                }

                if (!option.series || option.series.length === 0) {
                    console.error('图表配置缺少系列数据');
                    showError('图表配置缺少系列数据');
                    return false;
                }

                // 创建增强的配置，适配深色主题
                const enhancedOption = {
                    backgroundColor: 'transparent', // 透明背景，适配深色主题
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        }
                    },
                    legend: {
                        type: 'scroll',
                        orient: 'horizontal',
                        left: 'center',
                        bottom: 10
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '15%',
                        top: '10%',
                        containLabel: true
                    },
                    ...option
                };

                console.log('即将设置图表配置...');
                console.log('enhancedOption 预览:', JSON.stringify(enhancedOption).substring(0, 400));

                // 设置图表配置
                chart.setOption(enhancedOption, true);

                console.log('✅ 图表配置设置成功');
                console.log('图表实例:', chart);
                console.log('图表已初始化:', isInitialized);

                // 验证配置是否生效
                setTimeout(() => {
                    if (chart && isInitialized) {
                        const currentOption = chart.getOption();
                        console.log('当前图表配置验证:', currentOption ? '配置存在' : '配置为空');
                    }
                }, 100);

                return true;
            } catch (error) {
                console.error('❌ 设置图表配置失败:', error);
                console.error('错误类型:', error.name);
                console.error('错误消息:', error.message);
                console.error('错误堆栈:', error.stack);
                showError('设置图表配置失败: ' + error.message);
                return false;
            }
        }

        // 导出图片 - 增强版本，支持深色主题和自定义选项
        function exportChart(options = {}) {
            try {
                console.log('========== 开始导出图表 ==========');
                console.log('导出选项:', options);

                if (!isInitialized || !chart) {
                    throw new Error('图表未初始化');
                }

                const defaultOptions = {
                    type: 'png',
                    backgroundColor: '#1C1C1C', // 深色背景，与应用主题一致
                    pixelRatio: window.devicePixelRatio || 2,
                    excludeComponents: ['toolbox']
                };

                const exportOptions = { ...defaultOptions, ...options };
                console.log('最终导出选项:', exportOptions);

                const dataURL = chart.getDataURL(exportOptions);
                console.log('图表导出成功，数据长度:', dataURL.length);
                console.log('导出类型:', exportOptions.type);

                return dataURL;
            } catch (error) {
                console.error('❌ 导出图表失败:', error);
                console.error('错误详情:', error.message, error.stack);
                throw error;
            }
        }

        // 获取图表配置
        function getChartOption() {
            try {
                if (!isInitialized || !chart) {
                    throw new Error('图表未初始化');
                }

                return chart.getOption();
            } catch (error) {
                console.error('获取图表配置失败:', error);
                throw error;
            }
        }

        // 显示错误信息
        // 显示加载状态 - 增强版本
        function showLoading(message = '正在处理图表...') {
            const container = document.getElementById('chart-container');
            container.innerHTML = `<div class="loading" id="loading">
                <div class="loading-spinner"></div>
                ${message}
            </div>`;
            console.log('显示加载状态:', message);
        }

        // 显示错误信息 - 增强版本
        function showError(message) {
            console.error('显示错误信息:', message);
            const container = document.getElementById('chart-container');
            container.innerHTML = `<div class="error">
                <div style="font-size: 16px; margin-bottom: 8px;">⚠️ 图表加载失败</div>
                <div>${message}</div>
                <div style="font-size: 12px; margin-top: 12px; opacity: 0.8;">请检查网络连接或稍后重试</div>
            </div>`;
        }

        // 窗口大小改变时重新调整图表
        window.addEventListener('resize', function() {
            if (chart && isInitialized) {
                chart.resize();
            }
        });

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查 ECharts 库是否已加载
            function checkEChartsAndInit() {
                if (typeof echarts !== 'undefined') {
                    console.log('ECharts 库已加载，开始初始化图表');
                    if (initChart()) {
                        console.log('图表初始化完成，chartAPI 已就绪');
                    }
                } else {
                    console.log('等待 ECharts 库加载...');
                    // 如果 ECharts 还未加载，继续等待
                    setTimeout(checkEChartsAndInit, 200);
                }
            }
            
            // 延迟一点时间后开始检查
            setTimeout(checkEChartsAndInit, 100);
        });

        // 暴露接口给 HarmonyOS WebView
        // 在 ECharts 加载之前就暴露接口，但函数内部会检查初始化状态
        window.chartAPI = {
            setOption: setChartOption,
            exportImage: exportChart,
            getOption: getChartOption,
            init: initChart
        };
        
        // 确保在 ECharts 加载后也能正确初始化
        // 如果 ECharts 已经加载，立即初始化
        if (typeof echarts !== 'undefined') {
            console.log('ECharts 库在页面加载时已存在，立即初始化');
            setTimeout(initChart, 100);
        }
    </script>
</body>
</html>