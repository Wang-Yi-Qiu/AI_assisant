import router from '@ohos.router';
import { ChartConfig, UserData, generateChart } from '../utils/aiService';
import webview from '@ohos.web.webview';
import picker from '@ohos.file.picker';
import fs from '@ohos.file.fs';
import { BusinessError } from '@kit.BasicServicesKit';
import { util } from '@kit.ArkTS';

// å®šä¹‰æ¥å£
interface ChartExecutionResult {
  success: boolean;
  error?: string;
  stage?: string;
  result?: string;
}

interface PNGExportResult {
  success: boolean;
  dataURL?: string;
  error?: string;
}

interface DataWithArray {
  data: unknown[];
}

// è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨åœ°è·å–æ•°æ®é•¿åº¦
function getDataLength(userData: UserData): number {
  if (typeof userData === 'object' && userData !== null && 'data' in userData) {
    const dataArray = (userData as DataWithArray).data;
    return Array.isArray(dataArray) ? dataArray.length : 0;
  }
  return typeof userData === 'string' ? userData.length : 0;
}

// è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥UserDataæ˜¯å¦æœ‰æœ‰æ•ˆçš„æ•°æ®
function hasValidData(userData: UserData): boolean {
  return getDataLength(userData) > 0;
}

// å…¨å±€å˜é‡å­˜å‚¨å›¾è¡¨é…ç½®
let globalChartConfig: ChartConfig | null = null;
// å…¨å±€å˜é‡å­˜å‚¨åŸå§‹æ•°æ®ï¼ˆç”¨äºé‡æ–°ç”Ÿæˆï¼‰
let globalOriginalData: UserData | null = null;
// WebView æ§åˆ¶å™¨å¼•ç”¨
let webviewController: webview.WebviewController | null = null;

/**
 * è®¾ç½®å›¾è¡¨é…ç½®ï¼ˆä¾›å…¶ä»–é¡µé¢è°ƒç”¨ï¼‰
 * å¢å¼ºç‰ˆæœ¬ï¼šåŒ…å«é‡è¯•æœºåˆ¶å’Œè¯¦ç»†é”™è¯¯å¤„ç†
 */
export function setChartOption(config: ChartConfig, originalData?: UserData): void {
  console.info('[ChartPage] ========== setChartOption å¼€å§‹æ‰§è¡Œ ==========');
  console.info('[ChartPage] é…ç½®ç±»å‹:', typeof config);
  console.info('[ChartPage] é…ç½®é¢„è§ˆ:', JSON.stringify(config).substring(0, 200));

  globalChartConfig = config;

  // å¦‚æœæä¾›äº†åŸå§‹æ•°æ®ï¼Œä¿å­˜èµ·æ¥ç”¨äºé‡æ–°ç”Ÿæˆ
  if (originalData) {
    globalOriginalData = originalData;
    console.info('[ChartPage] åŸå§‹æ•°æ®å·²ä¿å­˜ï¼Œæ•°æ®è¡Œæ•°:', getDataLength(originalData));
  }

  // å¦‚æœ WebView å·²ç»åŠ è½½ï¼Œç«‹å³è®¾ç½®å›¾è¡¨é…ç½®
  if (webviewController) {
    console.info('[ChartPage] WebView å·²åŠ è½½ï¼Œå¼€å§‹è®¾ç½®å›¾è¡¨é…ç½®');
    applyChartConfigWithRetry(config, 0);
  } else {
    console.warn('[ChartPage] WebView å°šæœªåŠ è½½ï¼Œé…ç½®å·²ä¿å­˜ï¼Œç­‰å¾…é¡µé¢åŠ è½½');
  }
}

/**
 * è·å–åŸå§‹æ•°æ®ï¼ˆç”¨äºé‡æ–°ç”Ÿæˆï¼‰
 */
export function getOriginalData(): UserData | null {
  return globalOriginalData;
}

/**
 * è®¾ç½®åŸå§‹æ•°æ®
 */
export function setOriginalData(data: UserData): void {
  globalOriginalData = data;
  console.info('[ChartPage] åŸå§‹æ•°æ®å·²è®¾ç½®ï¼Œæ•°æ®è¡Œæ•°:', getDataLength(data));
}

/**
 * å¸¦é‡è¯•æœºåˆ¶çš„å›¾è¡¨é…ç½®åº”ç”¨
 */
function applyChartConfigWithRetry(config: ChartConfig, retryCount: number): void {
  const maxRetries = 5;
  const retryDelay = 500; // 500ms

  console.info(`[ChartPage] å°è¯•è®¾ç½®å›¾è¡¨é…ç½® (ç¬¬ ${retryCount + 1} æ¬¡)`);

  try {
    const configJson = JSON.stringify(config);

    // æ›´å¥å£®çš„JavaScriptä»£ç ï¼ŒåŒ…å«è¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯
    const jsCode = `(function() {
      console.log('=== JavaScript è¯Šæ–­ä¿¡æ¯ ===');
      console.log('window å¯¹è±¡å­˜åœ¨:', typeof window !== 'undefined');
      console.log('chartAPI å­˜åœ¨:', typeof window.chartAPI !== 'undefined');
      console.log('setOption å­˜åœ¨:', window.chartAPI && typeof window.chartAPI.setOption !== 'undefined');
      console.log('ECharts å­˜åœ¨:', typeof echarts !== 'undefined');

      try {
        // æ£€æŸ¥EChartsæ˜¯å¦å·²åŠ è½½
        if (typeof echarts === 'undefined') {
          console.error('ECharts åº“æœªåŠ è½½');
          return JSON.stringify({ success: false, error: 'EChartsåº“æœªåŠ è½½', stage: 'library_check' });
        }

        // æ£€æŸ¥chartAPIæ˜¯å¦å·²åˆå§‹åŒ–
        if (!window.chartAPI) {
          console.error('chartAPI å¯¹è±¡ä¸å­˜åœ¨');
          return JSON.stringify({ success: false, error: 'chartAPIå¯¹è±¡ä¸å­˜åœ¨', stage: 'api_check' });
        }

        if (!window.chartAPI.setOption) {
          console.error('setOption æ–¹æ³•ä¸å­˜åœ¨');
          return JSON.stringify({ success: false, error: 'setOptionæ–¹æ³•ä¸å­˜åœ¨', stage: 'method_check' });
        }

        // å°è¯•è°ƒç”¨setOption
        const option = ${configJson};
        console.log('å›¾è¡¨é…ç½®:', option);

        const result = window.chartAPI.setOption(option);
        console.log('setOption è°ƒç”¨ç»“æœ:', result);

        return JSON.stringify({ success: true, result: result, stage: 'success' });

      } catch (e) {
        console.error('JavaScript æ‰§è¡Œé”™è¯¯:', e);
        return JSON.stringify({ success: false, error: e.toString(), stage: 'javascript_error' });
      }
    })()`;

    if (!webviewController) {
      console.error('[ChartPage] WebView æ§åˆ¶å™¨æœªåˆå§‹åŒ–');
      return;
    }

    webviewController.runJavaScript(jsCode)
      .then((result) => {
        console.info('[ChartPage] JavaScript æ‰§è¡Œç»“æœ:', result);

        try {
          const parsedResult: ChartExecutionResult = JSON.parse(result);
          if (parsedResult.success) {
            console.info('[ChartPage] âœ… å›¾è¡¨é…ç½®è®¾ç½®æˆåŠŸï¼');
          } else {
            console.error('[ChartPage] âŒ å›¾è¡¨é…ç½®è®¾ç½®å¤±è´¥:', parsedResult.error, 'é˜¶æ®µ:', parsedResult.stage);

            // å¦‚æœæ˜¯APIæœªå°±ç»ªçš„é—®é¢˜ï¼Œè¿›è¡Œé‡è¯•
            if (retryCount < maxRetries &&
                (parsedResult.stage === 'api_check' || parsedResult.stage === 'method_check')) {
              console.info(`[ChartPage] ${retryDelay}ms åè¿›è¡Œç¬¬ ${retryCount + 2} æ¬¡é‡è¯•`);
              setTimeout(() => {
                applyChartConfigWithRetry(config, retryCount + 1);
              }, retryDelay);
            } else {
              console.error('[ChartPage] é‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œè®¾ç½®å¤±è´¥');
            }
          }
        } catch (parseError) {
          console.error('[ChartPage] è§£æJavaScriptç»“æœå¤±è´¥:', parseError);
          console.error('[ChartPage] åŸå§‹ç»“æœ:', result);
        }
      })
      .catch((err: Error) => {
        console.error('[ChartPage] runJavaScript æ‰§è¡Œå¤±è´¥:', err);

        // ç½‘ç»œæˆ–ç³»ç»Ÿé”™è¯¯ï¼Œè¿›è¡Œé‡è¯•
        if (retryCount < maxRetries) {
          console.info(`[ChartPage] ç³»ç»Ÿé”™è¯¯ï¼Œ${retryDelay}ms åè¿›è¡Œç¬¬ ${retryCount + 2} æ¬¡é‡è¯•`);
          setTimeout(() => {
            applyChartConfigWithRetry(config, retryCount + 1);
          }, retryDelay);
        }
      });

  } catch (error) {
    console.error('[ChartPage] åºåˆ—åŒ–å›¾è¡¨é…ç½®å¤±è´¥:', error);
  }
}

@Entry
@Component
export struct ChartPage {
  @State isLoading: boolean = true;
  @State chartConfig: ChartConfig | null = globalChartConfig;
  @State errorMessage: string = '';
  @State loadingMessage: string = 'æ­£åœ¨åŠ è½½å›¾è¡¨...';
  @State loadTimeout: number = 0; // ç”¨äºå­˜å‚¨è¶…æ—¶å®šæ—¶å™¨ID
  controller?: webview.WebviewController;

  aboutToAppear() {
    // æ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶ï¼Œé‡æ–°è·å–æœ€æ–°çš„å…¨å±€é…ç½®
    console.info('[ChartPage] aboutToAppear, å½“å‰å…¨å±€é…ç½®:', globalChartConfig ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
    if (globalChartConfig) {
      this.chartConfig = globalChartConfig;
      console.info('[ChartPage] å·²è®¾ç½®å›¾è¡¨é…ç½®:', JSON.stringify(globalChartConfig).substring(0, 100));
    } else {
      console.warn('[ChartPage] æ²¡æœ‰å›¾è¡¨é…ç½®ï¼Œå°†æ˜¾ç¤ºç©ºå›¾è¡¨');
      this.chartConfig = null;
      // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œç›´æ¥æ˜¾ç¤ºé”™è¯¯
      this.isLoading = false;
      this.errorMessage = 'æ²¡æœ‰å¯ç”¨çš„å›¾è¡¨é…ç½®ï¼Œè¯·å…ˆç”Ÿæˆå›¾è¡¨';
    }
  }

  aboutToDisappear() {
    // æ¸…ç†æ§åˆ¶å™¨å¼•ç”¨
    if (this.controller && webviewController === this.controller) {
      webviewController = null;
    }
    // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
    if (this.loadTimeout) {
      clearTimeout(this.loadTimeout);
      this.loadTimeout = 0;
    }
  }

  /**
   * æ›´æ–°å›¾è¡¨é…ç½®
   */
  updateChart(): Promise<boolean> {
    return new Promise((resolve) => {
      if (!this.chartConfig) {
        console.warn('[ChartPage] updateChart: æ²¡æœ‰å›¾è¡¨é…ç½®');
        this.errorMessage = 'æ²¡æœ‰å¯ç”¨çš„å›¾è¡¨é…ç½®';
        this.isLoading = false;
        resolve(false);
        return;
      }
      
      const controller = this.controller;
      if (!controller) {
        console.warn('[ChartPage] updateChart: WebView æ§åˆ¶å™¨æœªåˆå§‹åŒ–');
        this.errorMessage = 'WebView æ§åˆ¶å™¨æœªåˆå§‹åŒ–';
        this.isLoading = false;
        resolve(false);
        return;
      }
      
      try {
        const configJson = JSON.stringify(this.chartConfig);
        console.info('[ChartPage] updateChart: å‡†å¤‡æ‰§è¡Œ JavaScriptï¼Œé…ç½®é•¿åº¦:', configJson.length);
        
        const jsCode = `(function() {
          try {
            console.log('å¼€å§‹è®¾ç½®å›¾è¡¨é…ç½®...');
            if (typeof window === 'undefined') {
              console.error('window å¯¹è±¡ä¸å­˜åœ¨');
              return false;
            }
            if (!window.chartAPI) {
              console.warn('chartAPI æœªåˆå§‹åŒ–ï¼Œç­‰å¾…åˆå§‹åŒ–...');
              // ç­‰å¾… chartAPI åˆå§‹åŒ–ï¼Œæœ€å¤šç­‰å¾… 5 ç§’
              return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 50; // 50 * 100ms = 5ç§’
                const checkInterval = setInterval(() => {
                  attempts++;
                  if (window.chartAPI && window.chartAPI.setOption) {
                    clearInterval(checkInterval);
                    try {
                      window.chartAPI.setOption(${configJson});
                      console.log('å›¾è¡¨é…ç½®å·²è®¾ç½®ï¼ˆå»¶è¿Ÿï¼‰');
                      resolve(true);
                    } catch (e) {
                      console.error('è®¾ç½®å›¾è¡¨é…ç½®æ—¶å‡ºé”™:', e);
                      resolve(false);
                    }
                  } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    console.error('chartAPI åˆå§‹åŒ–è¶…æ—¶ï¼Œå·²å°è¯• ' + attempts + ' æ¬¡');
                    resolve(false);
                  }
                }, 100);
              });
            }
            if (!window.chartAPI.setOption) {
              console.error('chartAPI.setOption æ–¹æ³•ä¸å­˜åœ¨');
              return false;
            }
            window.chartAPI.setOption(${configJson});
            console.log('å›¾è¡¨é…ç½®å·²è®¾ç½®');
            return true;
          } catch (e) {
            console.error('è®¾ç½®å›¾è¡¨é…ç½®æ—¶å‡ºé”™:', e);
            return false;
          }
        })()`;
        
        controller.runJavaScript(jsCode)
          .then((result) => {
            console.info('[ChartPage] å›¾è¡¨é…ç½®æ›´æ–°å®Œæˆï¼Œç»“æœ:', result);
            if (result === 'true') {
              this.isLoading = false;
              this.errorMessage = '';
              resolve(true);
            } else {
              this.errorMessage = 'å›¾è¡¨é…ç½®è®¾ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–é‡è¯•';
              this.isLoading = false;
              resolve(false);
            }
          })
          .catch((err: Error) => {
            console.error('[ChartPage] æ›´æ–°å›¾è¡¨é…ç½®å¤±è´¥:', err);
            this.errorMessage = `å›¾è¡¨åŠ è½½å¤±è´¥: ${err.message}`;
            this.isLoading = false;
            resolve(false);
          });
      } catch (error) {
        console.error('[ChartPage] åºåˆ—åŒ–å›¾è¡¨é…ç½®å¤±è´¥:', error);
        this.errorMessage = 'å›¾è¡¨é…ç½®åºåˆ—åŒ–å¤±è´¥';
        this.isLoading = false;
        resolve(false);
      }
    });
  }

  /**
   * æ„å»ºåº•éƒ¨æ“ä½œæŒ‰é’®
   */
  @Builder
  ActionButton(icon: string, text: string, isPrimary: boolean, onClick: () => void) {
    Button() {
      Row() {
        Text(icon)
          .fontSize(20)
          .margin({ right: 8 })
        Text(text)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor(Color.White)
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
    }
    .type(ButtonType.Normal)
    .stateEffect(true)
    .width('48%')
    .height(50)
    .backgroundColor(isPrimary ? '#007DFF' : '#252525')
    .borderRadius(10)
    .onClick(onClick)
  }

  /**
   * å¯¼å‡ºPNGå›¾ç‰‡
   */
  async exportPNG(): Promise<void> {
    if (!webviewController) {
      console.error('[ChartPage] WebViewæ§åˆ¶å™¨æœªåˆå§‹åŒ–');
      return;
    }

    try {
      console.info('[ChartPage] å¼€å§‹å¯¼å‡ºPNGå›¾ç‰‡');

      // è°ƒç”¨JavaScriptå¯¼å‡ºå›¾è¡¨
      const jsCode = `
        (function() {
          try {
            console.log('å¼€å§‹å¯¼å‡ºPNG...');
            if (window.chartAPI && window.chartAPI.exportImage) {
              const dataURL = window.chartAPI.exportImage({
                type: 'png',
                backgroundColor: '#1C1C1C', // æ·±è‰²èƒŒæ™¯
                pixelRatio: 2
              });
              console.log('PNGå¯¼å‡ºæˆåŠŸï¼Œæ•°æ®é•¿åº¦:', dataURL.length);
              return JSON.stringify({ success: true, dataURL: dataURL });
            } else {
              return JSON.stringify({ success: false, error: 'å›¾è¡¨æœªåˆå§‹åŒ–æˆ–å¯¼å‡ºåŠŸèƒ½ä¸å¯ç”¨' });
            }
          } catch (e) {
            console.error('PNGå¯¼å‡ºå¤±è´¥:', e);
            return JSON.stringify({ success: false, error: e.toString() });
          }
        })()
      `;

      const result = await webviewController.runJavaScript(jsCode);
      const parsedResult: PNGExportResult = JSON.parse(result);

      if (parsedResult.success && parsedResult.dataURL) {
        await this.saveImageFile(parsedResult.dataURL, 'chart.png');
        console.info('[ChartPage] PNGå¯¼å‡ºå®Œæˆ');
      } else {
        console.error('[ChartPage] PNGå¯¼å‡ºå¤±è´¥:', parsedResult.error);
      }
    } catch (error) {
      console.error('[ChartPage] PNGå¯¼å‡ºå¼‚å¸¸:', error);
    }
  }

  /**
   * å¯¼å‡ºPDFæ–‡ä»¶ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„å®ç°ï¼‰
   */
  async exportPDF(): Promise<void> {
    // HarmonyOSçš„PDFå¯¼å‡ºç›¸å¯¹å¤æ‚ï¼Œè¿™é‡Œå…ˆæä¾›åŸºç¡€å®ç°
    // å¯ä»¥é€šè¿‡æ‰“å°æœåŠ¡æˆ–ç¬¬ä¸‰æ–¹åº“å®ç°
    console.info('[ChartPage] PDFå¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');

    // ä¸´æ—¶å®ç°ï¼šå…ˆå¯¼å‡ºPNGï¼Œåç»­å¯æ‰©å±•ä¸ºPDF
    await this.exportPNG();
  }

  /**
   * ä¿å­˜å›¾ç‰‡æ–‡ä»¶åˆ°æœ¬åœ°
   */
  private async saveImageFile(dataURL: string, fileName: string): Promise<void> {
    try {
      // ä»dataURLä¸­æå–base64æ•°æ®
      const base64Data = dataURL.replace(/^data:image\/png;base64,/, '');

      // å°†base64è½¬æ¢ä¸ºArrayBuffer
      const base64 = new util.Base64Helper();
      const uint8Array: Uint8Array = base64.decodeSync(base64Data);

      // ä½¿ç”¨æ–‡ä»¶ä¿å­˜å™¨ä¿å­˜æ–‡ä»¶
      const documentViewPicker = new picker.DocumentViewPicker();
      const documentSelectOptions = new picker.DocumentSelectOptions();
      documentSelectOptions.maxSelectNumber = 1;

      const documentSaveOptions = new picker.DocumentSaveOptions();
      documentSaveOptions.pickerMode = picker.DocumentPickerMode.SAVE_MODE;
      documentSaveOptions.newFileNames = [fileName];

      const uri = await documentViewPicker.save(documentSaveOptions);
      if (uri) {
        const file = fs.openSync(uri, fs.OpenMode.WRITE_ONLY);
        fs.writeSync(file.fd, uint8Array);
        fs.closeSync(file);
        console.info('[ChartPage] æ–‡ä»¶ä¿å­˜æˆåŠŸ:', uri);
      }
    } catch (error) {
      console.error('[ChartPage] ä¿å­˜æ–‡ä»¶å¤±è´¥:', error);
    }
  }

  /**
   * é‡æ–°ç”Ÿæˆå›¾è¡¨åŠŸèƒ½
   */
  async regenerateChart(chartType?: string): Promise<void> {
    if (this.isLoading) {
      return;
    }

    try {
      console.info('[ChartPage] ========== å¼€å§‹é‡æ–°ç”Ÿæˆå›¾è¡¨ ==========');

      // æ£€æŸ¥æ˜¯å¦æœ‰åŸå§‹æ•°æ®
      const originalData = getOriginalData();
      if (!originalData || !hasValidData(originalData)) {
        throw new Error('æ²¡æœ‰åŸå§‹æ•°æ®ç”¨äºé‡æ–°ç”Ÿæˆå›¾è¡¨');
      }

      console.info('[ChartPage] ä½¿ç”¨åŸå§‹æ•°æ®é‡æ–°ç”Ÿæˆå›¾è¡¨ï¼Œæ•°æ®è¡Œæ•°:', getDataLength(originalData));

      this.isLoading = true;
      this.loadingMessage = 'æ­£åœ¨é‡æ–°ç”Ÿæˆå›¾è¡¨...';

      // generateChartå‡½æ•°å·²ä»æ¨¡å—å¯¼å…¥

      // å¦‚æœæŒ‡å®šäº†å›¾è¡¨ç±»å‹ï¼Œå¯ä»¥åœ¨è¿™é‡Œå¤„ç†
      let userData = originalData;
      if (chartType) {
        // å¯ä»¥æ ¹æ®chartTypeè°ƒæ•´ç”¨æˆ·æ•°æ®çš„é…ç½®
        console.info('[ChartPage] æŒ‡å®šå›¾è¡¨ç±»å‹:', chartType);
        userData = Object.assign({}, originalData, { chartType });
      }

      // è°ƒç”¨AIæœåŠ¡é‡æ–°ç”Ÿæˆå›¾è¡¨é…ç½®
      const newChartConfig: ChartConfig = await generateChart(userData);
      console.info('[ChartPage] æ–°å›¾è¡¨é…ç½®ç”ŸæˆæˆåŠŸ');

      // æ›´æ–°å…¨å±€é…ç½®
      globalChartConfig = newChartConfig;
      this.chartConfig = newChartConfig;

      // åº”ç”¨æ–°çš„å›¾è¡¨é…ç½®
      if (webviewController) {
        console.info('[ChartPage] åº”ç”¨æ–°çš„å›¾è¡¨é…ç½®');
        applyChartConfigWithRetry(newChartConfig, 0);
      } else {
        console.warn('[ChartPage] WebViewæ§åˆ¶å™¨æœªåˆå§‹åŒ–');
      }

      console.info('[ChartPage] âœ… å›¾è¡¨é‡æ–°ç”Ÿæˆå®Œæˆ');

    } catch (error) {
      console.error('[ChartPage] âŒ é‡æ–°ç”Ÿæˆå›¾è¡¨å¤±è´¥:', error);

      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      this.errorMessage = `é‡æ–°ç”Ÿæˆå¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`;
      this.isLoading = false;

      // å»¶è¿Ÿæ¸…é™¤é”™è¯¯æ¶ˆæ¯
      setTimeout(() => {
        this.errorMessage = '';
      }, 3000);
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    Column() {
      // å¤´éƒ¨å¯¼èˆªæ 
      Row() {
        // è¿”å›æŒ‰é’®ï¼ˆå·¦ä¸Šæ–¹ï¼‰
        Button() {
          Text('â†')
            .fontSize(24)
            .fontColor(Color.White)
        }
        .type(ButtonType.Normal)
        .backgroundColor(Color.Transparent)
        .width(40)
        .height(40)
        .onClick(() => {
          router.back();
        })

        Blank()

        // æ ‡é¢˜ï¼ˆå±…ä¸­æ˜¾ç¤ºï¼‰
        Text('å›¾è¡¨é¢„è§ˆ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)

        Blank()

        // å³ä¾§å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
        Blank()
          .width(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 15, right: 15 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      // å¯æ»šåŠ¨å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // å›¾è¡¨æ¸²æŸ“åŒºåŸŸï¼ˆå æ®ä¸»è¦éƒ¨åˆ†ï¼‰
          Stack() {
            if (this.isLoading) {
              Column() {
                Text('âœ¨')
                  .fontSize(48)
                  .margin({ bottom: 15 })
                LoadingProgress()
                  .width(40)
                  .height(40)
                  .margin({ bottom: 15 })
                Text('æ­£åœ¨åŠ è½½å›¾è¡¨...')
                  .fontSize(16)
                  .fontColor(Color.Gray)
              }
              .width('100%')
              .height('100%')
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
            } else if (this.errorMessage) {
              Column() {
                Text('âš ï¸')
                  .fontSize(48)
                  .margin({ bottom: 15 })
                Text(this.errorMessage)
                  .fontSize(14)
                  .fontColor('#FF6B6B')
                  .textAlign(TextAlign.Center)
                  .padding({ left: 20, right: 20 })
                  .margin({ bottom: 15 })
                Button() {
                  Text('é‡è¯•')
                    .fontColor(Color.White)
                }
                .type(ButtonType.Normal)
                .backgroundColor('#007DFF')
                .onClick(() => {
                  this.isLoading = true;
                  this.errorMessage = '';
                  // é‡æ–°åŠ è½½é¡µé¢
                  if (this.controller) {
                    this.controller.refresh();
                  }
                })
              }
              .width('100%')
              .height('100%')
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
            }
            // WebView ç»„ä»¶ç”¨äºæ¸²æŸ“å›¾è¡¨ï¼ˆåªåœ¨éé”™è¯¯çŠ¶æ€ä¸‹æ˜¾ç¤ºï¼‰
            if (!this.errorMessage) {
              Web({ src: 'resource:///rawfile/chart.html', controller: this.controller })
                .width('100%')
                .height('100%')
                .javaScriptAccess(true)
                .domStorageAccess(true)
                .fileAccess(true)
              .onControllerAttached(() => {
                // WebView æ§åˆ¶å™¨å·²é™„åŠ ï¼Œé€šè¿‡ this.controller è®¿é—®
                if (this.controller) {
                  webviewController = this.controller;
                }
              })
              .onPageEnd((event) => {
                console.info('[ChartPage] WebView é¡µé¢åŠ è½½å®Œæˆ:', event?.url);
                // é¡µé¢åŠ è½½å®Œæˆåï¼Œå†æ¬¡æ£€æŸ¥å…¨å±€é…ç½®ï¼ˆå¯èƒ½åœ¨é¡µé¢åŠ è½½è¿‡ç¨‹ä¸­è¢«è®¾ç½®ï¼‰
                if (globalChartConfig && !this.chartConfig) {
                  this.chartConfig = globalChartConfig;
                  console.info('[ChartPage] åœ¨é¡µé¢åŠ è½½åè·å–åˆ°é…ç½®');
                }
                
                // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶å®šæ—¶å™¨
                if (this.loadTimeout) {
                  clearTimeout(this.loadTimeout);
                }
                
                // è®¾ç½®è¶…æ—¶æœºåˆ¶ï¼ˆ10ç§’åå¦‚æœè¿˜æ²¡åŠ è½½å®Œæˆï¼Œæ˜¾ç¤ºé”™è¯¯ï¼‰
                this.loadTimeout = setTimeout(() => {
                  if (this.isLoading) {
                    console.error('[ChartPage] å›¾è¡¨åŠ è½½è¶…æ—¶');
                    this.errorMessage = 'å›¾è¡¨åŠ è½½è¶…æ—¶ï¼Œå¯èƒ½æ˜¯ç½‘ç»œè¿æ¥é—®é¢˜æˆ– ECharts åº“åŠ è½½å¤±è´¥';
                    this.isLoading = false;
                  }
                }, 10000) ;
                
                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿ chartAPI å·²åˆå§‹åŒ–
                setTimeout(() => {
                  if (this.chartConfig) {
                    console.info('[ChartPage] å¼€å§‹æ›´æ–°å›¾è¡¨ï¼Œé…ç½®:', JSON.stringify(this.chartConfig).substring(0, 100));
                    this.updateChart().then((success) => {
                      // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                      if (this.loadTimeout) {
                        clearTimeout(this.loadTimeout);
                        this.loadTimeout = 0;
                      }
                      if (!success) {
                        console.error('[ChartPage] å›¾è¡¨æ›´æ–°å¤±è´¥');
                      }
                    });
                  } else {
                    console.warn('[ChartPage] æ²¡æœ‰å›¾è¡¨é…ç½®ï¼Œæ˜¾ç¤ºç©ºå›¾è¡¨');
                    this.errorMessage = 'æ²¡æœ‰å¯ç”¨çš„å›¾è¡¨é…ç½®ï¼Œè¯·å…ˆç”Ÿæˆå›¾è¡¨';
                    this.isLoading = false;
                    // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                    if (this.loadTimeout) {
                      clearTimeout(this.loadTimeout);
                      this.loadTimeout = 0;
                    }
                  }
                }, 1500); // å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼Œç¡®ä¿ ECharts åº“æœ‰è¶³å¤Ÿæ—¶é—´åŠ è½½
              })
              .onConsole((event) => {
                const message = event.message?.getMessage();
                if (message) {
                  console.info('WebView Console:', message);
                }
                return true;
              })
              .onErrorReceive((event) => {
                const error = event?.error;
                if (error) {
                  const errorCode = error.getErrorCode();
                  const errorInfo = error.getErrorInfo();
                  console.error('WebView åŠ è½½é”™è¯¯:', `Code: ${errorCode}, Info: ${errorInfo}`);
                  this.errorMessage = `é¡µé¢åŠ è½½å¤±è´¥: ${errorInfo || 'æœªçŸ¥é”™è¯¯'}`;
                } else {
                  console.error('WebView åŠ è½½é”™è¯¯: æœªçŸ¥é”™è¯¯');
                  this.errorMessage = 'é¡µé¢åŠ è½½å¤±è´¥: æœªçŸ¥é”™è¯¯';
                }
                this.isLoading = false;
                // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                if (this.loadTimeout) {
                  clearTimeout(this.loadTimeout);
                  this.loadTimeout = 0;
                }
              })
            }
          }
          .width('100%')
          .height(400) // è®¾ç½®å›ºå®šé«˜åº¦è€Œéç™¾åˆ†æ¯”ï¼Œç¡®ä¿å›¾è¡¨åŒºåŸŸæœ‰è¶³å¤Ÿç©ºé—´
          .backgroundColor('#252525')
          .borderRadius(15)
          .margin({ bottom: 20 })

          // AI è‡ªåŠ¨åˆ†ææŠ¥å‘ŠåŒº
          Column() {
            Row() {
              Text('âœ¨')
                .fontSize(24)
                .margin({ right: 10 })
              Text('AI è‡ªåŠ¨åˆ†ææŠ¥å‘Š')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor(Color.White)
            }
            .width('100%')
            .margin({ bottom: 12 })
            .alignItems(VerticalAlign.Center)

            Text('è¿™æ˜¯ä¸€ä¸ªç®€çŸ­çš„æ–‡æœ¬å—ï¼Œç”¨äºæ˜¾ç¤º AI è‡ªåŠ¨ç”Ÿæˆçš„åˆ†ææŠ¥å‘Šã€‚')
              .fontSize(14)
              .fontColor(Color.Gray)
              .lineHeight(20)
              .width('100%')
          }
          .padding(20)
          .width('100%')
          .backgroundColor('#252525')
          .borderRadius(15)
          .margin({ bottom: 20 })
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        .padding({ left: 15, right: 15 })
        .alignItems(HorizontalAlign.Center)
      }
      .layoutWeight(1)
      .width('100%')
      .scrollable(ScrollDirection.Vertical) // æ˜ç¡®æŒ‡å®šå‚ç›´æ»šåŠ¨
      .scrollBar(BarState.Auto) // è‡ªåŠ¨æ˜¾ç¤ºæ»šåŠ¨æ¡
      .edgeEffect(EdgeEffect.Spring) // æ·»åŠ å¼¹æ€§æ»šåŠ¨æ•ˆæœ

      // åº•éƒ¨æ“ä½œæŒ‰é’®åŒº
      Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.SpaceBetween }) {
        // å¯¼å‡º PNG
        this.ActionButton('ğŸ–¼ï¸', 'å¯¼å‡º PNG', false, async () => {
          console.info('å¯¼å‡º PNG è¢«ç‚¹å‡»');
          await this.exportPNG();
        })

        // å¯¼å‡º PDF
        this.ActionButton('ğŸ“„', 'å¯¼å‡º PDF', false, async () => {
          console.info('å¯¼å‡º PDF è¢«ç‚¹å‡»');
          await this.exportPDF();
        })

        // é‡æ–°ç”Ÿæˆ
        this.ActionButton('ğŸ”„', 'é‡æ–°ç”Ÿæˆ', false, async () => {
          console.info('é‡æ–°ç”Ÿæˆè¢«ç‚¹å‡»');
          await this.regenerateChart();
        })

        // æ›´æ¢å›¾è¡¨ï¼ˆä¸»è‰²è°ƒï¼‰
        this.ActionButton('ğŸ“ˆ', 'æ›´æ¢å›¾è¡¨', true, () => {
          console.info('æ›´æ¢å›¾è¡¨è¢«ç‚¹å‡»');
          router.pushNamedRoute({
            name: 'ChartTypeSelectorPage'
          }).catch((err: BusinessError) => {
            console.error('è·³è½¬åˆ°å›¾è¡¨ç±»å‹é€‰æ‹©é¡µé¢å¤±è´¥:', err);
          });
        })
      }
      .width('100%')
      .padding({ left: 15, right: 15, top: 15, bottom: 15 })
      .backgroundColor('#1C1C1C')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#1C1C1C')
  }
}