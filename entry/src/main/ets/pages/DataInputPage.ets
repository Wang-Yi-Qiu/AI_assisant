/**
 * æ•°æ®è¾“å…¥é¡µé¢
 * æ”¯æŒè¡¨æ ¼å½¢å¼çš„æ‰‹åŠ¨æ•°æ®è¾“å…¥
 * @module DataInputPage
 */

import router from '@ohos.router';
import { generateChartLocal, ChartConfig, UserData, CSVData } from '../utils/aiService';
import { setChartOption } from './ChartPage';
import { ErrorHandler } from '../utils/errorHandler';

// å®šä¹‰è¡¨æ ¼æ•°æ®è¡Œç±»å‹ï¼ˆä½¿ç”¨Mapæ›¿ä»£ç´¢å¼•ç­¾åï¼‰
type TableRow = Map<string, string>;

@Entry
@Component
export struct DataInputPage {
  @State isLoading: boolean = false;
  @State loadingMessage: string = 'æ­£åœ¨ç”Ÿæˆå›¾è¡¨...';
  @State tableData: TableRow[] = [];
  @State headers: string[] = ['ç±»åˆ« (Xè½´)', 'æ•°å€¼ (Yè½´)', 'å¤‡æ³¨']; // é»˜è®¤è¡¨å¤´ - æ›´å…·è¯­ä¹‰å’Œå¼•å¯¼æ€§
  @State rowCount: number = 3;
  @State columnCount: number = 3;

  aboutToAppear(): void {
    console.info('[DataInputPage] é¡µé¢åˆå§‹åŒ–');
    this.initializeTable();
  }

  /**
   * åˆå§‹åŒ–è¡¨æ ¼
   */
  initializeTable(): void {
    this.tableData = [];
    for (let i = 0; i < this.rowCount; i++) {
      const row: TableRow = new Map<string, string>();
      for (let j = 0; j < this.columnCount; j++) {
        row.set(this.headers[j], '');
      }
      this.tableData.push(row);
    }
    console.info('[DataInputPage] è¡¨æ ¼åˆå§‹åŒ–å®Œæˆï¼Œè¡Œæ•°:', this.rowCount, 'åˆ—æ•°:', this.columnCount);
  }

  /**
   * æ·»åŠ æ–°è¡Œ
   */
  addRow(): void {
    const newRow: Map<string, string> = new Map<string, string>();
    for (let j = 0; j < this.columnCount; j++) {
      newRow.set(this.headers[j], '');
    }
    this.tableData.push(newRow);
    this.rowCount++;
    console.info('[DataInputPage] æ·»åŠ æ–°è¡Œï¼Œå½“å‰è¡Œæ•°:', this.rowCount);
  }

  /**
   * åˆ é™¤è¡Œ
   */
  removeRow(index: number): void {
    if (this.tableData.length > 1) {
      this.tableData.splice(index, 1);
      this.rowCount--;
      console.info('[DataInputPage] åˆ é™¤ç¬¬', index + 1, 'è¡Œ');
    }
  }

  /**
   * æ·»åŠ æ–°åˆ—
   */
  addColumn(): void {
    const newColumnName = `å­—æ®µ${this.columnCount + 1}`;
    this.headers.push(newColumnName);
    this.columnCount++;

    // ä¸ºç°æœ‰è¡Œæ·»åŠ æ–°åˆ—
    this.tableData.forEach(row => {
      row.set(newColumnName, '');
    });

    console.info('[DataInputPage] æ·»åŠ æ–°åˆ—:', newColumnName);
  }

  /**
   * åˆ é™¤åˆ—
   */
  removeColumn(index: number): void {
    if (this.headers.length > 1) {
      const columnName = this.headers[index];
      this.headers.splice(index, 1);
      this.columnCount--;

      // ä»æ‰€æœ‰è¡Œä¸­åˆ é™¤è¯¥åˆ—
      this.tableData.forEach(row => {
        row.delete(columnName);
      });

      console.info('[DataInputPage] åˆ é™¤åˆ—:', columnName);
    }
  }

  /**
   * æ›´æ–°å•å…ƒæ ¼æ•°æ®
   */
  updateCell(rowIndex: number, columnName: string, value: string): void {
    if (this.tableData[rowIndex]) {
      this.tableData[rowIndex].set(columnName, value);
    }
  }

  /**
   * æ›´æ–°è¡¨å¤´
   */
  updateHeader(index: number, value: string): void {
    if (this.headers[index]) {
      const oldName = this.headers[index];
      this.headers[index] = value;

      // æ›´æ–°æ‰€æœ‰è¡Œä¸­çš„é”®å
      this.tableData.forEach(row => {
        if (row.has(oldName)) {
          const oldValue = row.get(oldName);
          if (oldValue !== undefined) {
            row.set(value, oldValue);
          }
          row.delete(oldName);
        }
      });
    }
  }

  /**
   * ç”Ÿæˆå›¾è¡¨
   */
  async generateChartFromData(): Promise<void> {
    if (this.isLoading) {
      return;
    }

    try {
      console.info('[DataInputPage] ========== å¼€å§‹ç”Ÿæˆå›¾è¡¨ ==========');
      this.isLoading = true;
      this.loadingMessage = 'æ­£åœ¨éªŒè¯æ•°æ®...';

      // éªŒè¯æ•°æ®
      const userData = this.validateAndPrepareData();

      if (!userData) {
        throw new Error('æ²¡æœ‰æœ‰æ•ˆçš„æ•°æ®è¡Œï¼Œè¯·å¡«å†™æ•°æ®åå†ç”Ÿæˆå›¾è¡¨');
      }

      this.loadingMessage = 'æ­£åœ¨ç”Ÿæˆæœ¬åœ°å›¾è¡¨...';

      // ä½¿ç”¨æœ¬åœ°æœåŠ¡ç”Ÿæˆå›¾è¡¨ï¼ˆæ— éœ€APIè°ƒç”¨ï¼‰
      const chartConfig: ChartConfig = await generateChartLocal(userData);
      console.info('[DataInputPage] å›¾è¡¨é…ç½®ç”ŸæˆæˆåŠŸ');

      // è®¾ç½®å›¾è¡¨é…ç½®å¹¶è·³è½¬
      setChartOption(chartConfig, userData);
      console.info('[DataInputPage] å›¾è¡¨é…ç½®å·²è®¾ç½®ï¼Œå‡†å¤‡è·³è½¬');

      // è·³è½¬åˆ°å›¾è¡¨é¡µé¢
      await router.pushUrl({
        url: 'pages/ChartPage'
      });

      console.info('[DataInputPage] å·²è·³è½¬åˆ°å›¾è¡¨é¡µé¢');

    } catch (error) {
      console.error('[DataInputPage] ç”Ÿæˆå›¾è¡¨å¤±è´¥:', error);
      const appError = ErrorHandler.handle(error, 'generateChartFromData');

      // æ˜¾ç¤ºé”™è¯¯æç¤º
      this.loadingMessage = `ç”Ÿæˆå¤±è´¥: ${appError.userMessage}`;

      // å»¶è¿Ÿæ¸…é™¤é”™è¯¯æ¶ˆæ¯
      setTimeout(() => {
        this.loadingMessage = 'æ­£åœ¨ç”Ÿæˆå›¾è¡¨...';
      }, 3000);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * éªŒè¯å¹¶å‡†å¤‡æ•°æ®
   */
  validateAndPrepareData(): UserData | null {
    try {
      console.info('[DataInputPage] å¼€å§‹éªŒè¯å’Œå‡†å¤‡æ•°æ®');
      console.info('[DataInputPage] åŸå§‹æ•°æ®è¡Œæ•°:', this.tableData.length);
      console.info('[DataInputPage] è¡¨å¤´:', this.headers);

      // è¿‡æ»¤æœ‰æ•ˆè¡Œï¼ˆè‡³å°‘æœ‰ä¸€ä¸ªéç©ºå­—æ®µï¼‰
      const validRows: Map<string, string>[] = this.tableData.filter(row => {
        let hasValidValue = false;
        row.forEach((value) => {
          if (value && value.trim() !== '') {
            hasValidValue = true;
          }
        });
        return hasValidValue;
      });

      console.info('[DataInputPage] æœ‰æ•ˆæ•°æ®è¡Œæ•°:', validRows.length);

      if (validRows.length === 0) {
        return null;
      }

      // è½¬æ¢æ•°æ®æ ¼å¼ï¼Œè‡ªåŠ¨è¯†åˆ«æ•°å­—
      const processedData: Record<string, string | number>[] = validRows.map(row => {
        const processedRow: Record<string, string | number> = {};
        this.headers.forEach(header => {
          const value = row.get(header);
          if (value && value.trim() !== '') {
            // å°è¯•è½¬æ¢ä¸ºæ•°å­—
            const numValue = Number(value);
            processedRow[header] = isNaN(numValue) ? value.trim() : numValue;
          }
        });
        return processedRow;
      });

      console.info('[DataInputPage] æ•°æ®å¤„ç†å®Œæˆ');
      return { data: processedData };

    } catch (error) {
      console.error('[DataInputPage] æ•°æ®éªŒè¯å¤±è´¥:', error);
      throw new Error(`æ•°æ®éªŒè¯å¤±è´¥: ${error}`);
    }
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  goBack(): void {
    router.back();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(24)
            .fontColor(Color.White)
        }
        .type(ButtonType.Normal)
        .backgroundColor(Color.Transparent)
        .width(40)
        .height(40)
        .onClick(() => {
          this.goBack();
        })

        Blank()

        Text('æ‰‹åŠ¨è¾“å…¥æ•°æ®')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)

        Blank()
          .width(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 20, right: 20, top: 16, bottom: 16 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)
      .backgroundColor('#121826')

      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // æ“ä½œæç¤º - AIåŠŸèƒ½å¼•å¯¼
          Text('è¾“å…¥æ•°æ®è®©AIä¸ºæ‚¨æ™ºèƒ½ç”Ÿæˆç²¾ç¾å›¾è¡¨')
            .fontSize(14)
            .fontWeight(FontWeight.Normal)
            .fontColor('#AAAAAA')
            .margin({ top: 12, bottom: 16 })
            .textAlign(TextAlign.Start)
            .width('90%')

          // è¡¨æ ¼æ“ä½œæŒ‰é’®
          Row() {
            Button('+ æ·»åŠ è¡Œ')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .backgroundColor('#0095FF')
              .fontColor(Color.White)
              .borderRadius(8)
              .padding({ left: 20, right: 20, top: 12, bottom: 12 })
              .onClick(() => {
                this.addRow();
              })

            Button('+ æ·»åŠ åˆ—')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .backgroundColor('#1E2430')
              .fontColor(Color.White)
              .borderRadius(8)
              .padding({ left: 20, right: 20, top: 12, bottom: 12 })
              .margin({ left: 12 })
              .onClick(() => {
                this.addColumn();
              })
          }
          .width('90%')
          .justifyContent(FlexAlign.Start)
          .margin({ bottom: 20 })

          // æ•°æ®è¡¨æ ¼
          Column() {
            // è¡¨å¤´ - å¸¦æœ‰ç±»å‹å›¾æ ‡çš„è¯­ä¹‰åŒ–è¡¨å¤´
            Row() {
              ForEach(this.headers, (header: string, index?: number) => {
                Row() {
                  // ç±»å‹å›¾æ ‡
                  if (index === 0) {
                    Text('Aa')
                      .fontSize(12)
                      .fontColor('#AAAAAA')
                      .fontWeight(FontWeight.Bold)
                      .margin({ right: 6 })
                  } else if (index === 1) {
                    Text('#')
                      .fontSize(14)
                      .fontColor('#AAAAAA')
                      .fontWeight(FontWeight.Bold)
                      .margin({ right: 6 })
                  } else {
                    Text('ğŸ“')
                      .fontSize(12)
                      .margin({ right: 6 })
                  }

                  // è¡¨å¤´æ–‡å­—
                  Text(header)
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(Color.White)
                }
                .width('33%')
                .height(40)
                .justifyContent(FlexAlign.Center)
                .alignItems(VerticalAlign.Center)
                .margin({ right: 8 })
              }, (header: string, index?: number) => (index ?? 0).toString())
            }
            .width('100%')
            .justifyContent(FlexAlign.Start)
            .margin({ bottom: 16 })

            // æ•°æ®è¡Œ - æ™ºèƒ½è¾“å…¥è¡Œä¸º
            ForEach(this.tableData, (row: Map<string, string>, rowIndex?: number) => {
              Row() {
                // ç¬¬ä¸€åˆ—ï¼šç±»åˆ«è¾“å…¥
                TextInput({
                  text: row.get(this.headers[0]) || '',
                  placeholder: rowIndex === 0 ? 'å¦‚ï¼šè‹¹æœ' : 'è¾“å…¥ç±»åˆ«'
                })
                  .width('33%')
                  .height(40)
                  .fontSize(14)
                  .backgroundColor('#1E2430')
                  .fontColor(Color.White)
                  .placeholderColor('#AAAAAA')
                  .margin({ right: 8 })
                  .borderRadius(6)
                  .padding({ left: 12, right: 12 })
                  .type(InputType.Normal)
                  .onChange((value: string) => {
                    this.updateCell(rowIndex as number, this.headers[0], value);
                  })

                // ç¬¬äºŒåˆ—ï¼šæ•°å€¼è¾“å…¥
                TextInput({
                  text: row.get(this.headers[1]) || '',
                  placeholder: rowIndex === 0 ? 'å¦‚ï¼š50' : 'è¾“å…¥æ•°å€¼'
                })
                  .width('33%')
                  .height(40)
                  .fontSize(14)
                  .backgroundColor('#1E2430')
                  .fontColor(Color.White)
                  .placeholderColor('#AAAAAA')
                  .margin({ right: 8 })
                  .borderRadius(6)
                  .padding({ left: 12, right: 12 })
                  .type(InputType.Number)
                  .onChange((value: string) => {
                    this.updateCell(rowIndex as number, this.headers[1], value);
                  })

                // ç¬¬ä¸‰åˆ—ï¼šå¤‡æ³¨è¾“å…¥
                TextInput({
                  text: row.get(this.headers[2]) || '',
                  placeholder: rowIndex === 0 ? 'å¯é€‰å¤‡æ³¨' : 'å¤‡æ³¨ä¿¡æ¯'
                })
                  .width('33%')
                  .height(40)
                  .fontSize(14)
                  .backgroundColor('#1E2430')
                  .fontColor(Color.White)
                  .placeholderColor('#AAAAAA')
                  .borderRadius(6)
                  .padding({ left: 12, right: 12 })
                  .type(InputType.Normal)
                  .onChange((value: string) => {
                    this.updateCell(rowIndex as number, this.headers[2], value);
                  })
              }
              .width('100%')
              .justifyContent(FlexAlign.Start)
              .margin({ bottom: 8 })
            }, (row: Map<string, string>, rowIndex?: number) => (rowIndex ?? 0).toString())
          }
          .width('90%')
          .padding(16)
          .backgroundColor('transparent')
          .margin({ bottom: 24 })

          // AI ç”ŸæˆæŒ‰é’® - å¸¦æ¸å˜è‰²å’Œç§‘æŠ€æ„Ÿ
          Button() {
            Row() {
              Text('âœ¨')
                .fontSize(18)
                .margin({ right: 8 })
              Text('AI ç”Ÿæˆå›¾è¡¨')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor(Color.White)
            }
            .justifyContent(FlexAlign.Center)
            .alignItems(VerticalAlign.Center)
          }
            .width('90%')
            .height(50)
            .linearGradient({
              direction: GradientDirection.Right,
              colors: [['#0095FF', 0.0], ['#7B3FF2', 1.0]]
            })
            .borderRadius(12)
            .enabled(!this.isLoading && this.tableData.length > 0)
            .onClick(() => {
              this.generateChartFromData();
            })
            .margin({ top: 32, bottom: 20 })
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
        .padding({ top: 20, bottom: 20 })
      }
      .layoutWeight(1)
      .width('100%')

      // åŠ è½½çŠ¶æ€æç¤º
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .margin({ bottom: 10 })
          Text(this.loadingMessage)
            .fontSize(14)
            .fontColor('#AAAAAA')
        }
        .width('100%')
        .padding(20)
        .backgroundColor('#121826')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#121826')
  }
}