import router from '@ohos.router';
import { LocalChartService, LocalChartData, ExportFormat } from '../utils/localChartService';
import { ErrorHandler } from '../utils/errorHandler';
import { BusinessError } from '@kit.BasicServicesKit';

@Entry
@Component
export struct AIAssistantPage {
  @State isLoading: boolean = false;
  @State loadingMessage: string = 'æ­£åœ¨åŠ è½½...';
  private localChartService: LocalChartService = LocalChartService.getInstance();

  aboutToAppear() {
    console.info('[AIAssistantPage] é¡µé¢åˆå§‹åŒ–');
  }

  /**
   * ä½¿ç”¨ç¤ºä¾‹æ•°æ®ç”Ÿæˆå›¾è¡¨
   */
  async handleUseSampleData(dataType: 'sales' | 'weather' | 'students') {
    if (this.isLoading) {
      return;
    }

    this.isLoading = true;
    this.loadingMessage = 'æ­£åœ¨ç”Ÿæˆç¤ºä¾‹æ•°æ®...';

    try {
      console.info('[AIAssistantPage] å¼€å§‹ç”Ÿæˆç¤ºä¾‹æ•°æ®:', dataType);

      // ç”Ÿæˆç¤ºä¾‹æ•°æ®
      const chartData = this.localChartService.generateSampleData(dataType);
      console.info('[AIAssistantPage] ç¤ºä¾‹æ•°æ®ç”Ÿæˆå®Œæˆ');

      // è·³è½¬åˆ°æ™ºèƒ½å›¾è¡¨é€‰æ‹©é¡µé¢
      await router.pushUrl({
        url: 'pages/SmartChartSelectorPage',
        params: {
          'parsedData': {
            fileName: 'sample_data.csv',
            headers: chartData.headers,
            data: chartData.rows.map(row => {
              const obj: Record<string, Object> = {};
              chartData.headers.forEach((header, index) => {
                obj[header] = row[index];
              });
              return obj;
            }),
            rowCount: chartData.rows.length,
            columnCount: chartData.headers.length
          }
        }
      });

      console.info('[AIAssistantPage] å·²è·³è½¬åˆ°æœ¬åœ°å›¾è¡¨é¡µé¢');
    } catch (error) {
      console.error('[AIAssistantPage] ç”Ÿæˆç¤ºä¾‹æ•°æ®å¤±è´¥:', error);
      this.loadingMessage = `ç”Ÿæˆå¤±è´¥: ${error}`;

      setTimeout(() => {
        this.loadingMessage = 'æ­£åœ¨åŠ è½½...';
      }, 3000);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨å¹¶å¤„ç†CSVæ–‡ä»¶
   */
  async handleFileUpload(): Promise<void> {
    if (this.isLoading) {
      return;
    }

    this.isLoading = true;
    this.loadingMessage = 'æ­£åœ¨é€‰æ‹©æ–‡ä»¶...';

    try {
      console.info('[AIAssistantPage] å¼€å§‹æ–‡ä»¶ä¸Šä¼ ');

      // ä½¿ç”¨æœ¬åœ°æœåŠ¡è§£æCSV
      const chartData = await this.localChartService.selectAndParseCSV();

      if (chartData) {
        console.info('[AIAssistantPage] CSVè§£ææˆåŠŸ');

        // è·³è½¬åˆ°æ™ºèƒ½å›¾è¡¨é€‰æ‹©é¡µé¢
        await router.pushUrl({
          url: 'pages/SmartChartSelectorPage',
          params: {
            'parsedData': {
              fileName: chartData.fileName,
              headers: chartData.headers,
              data: chartData.data,
              rowCount: chartData.data.length,
              columnCount: chartData.headers.length
            }
          }
        });

        console.info('[AIAssistantPage] å·²è·³è½¬åˆ°æœ¬åœ°å›¾è¡¨é¡µé¢');
      } else {
        throw new Error('CSVæ–‡ä»¶è§£æå¤±è´¥');
      }
    } catch (error) {
      console.error('[AIAssistantPage] æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
      this.loadingMessage = `ä¸Šä¼ å¤±è´¥: ${error}`;

      setTimeout(() => {
        this.loadingMessage = 'æ­£åœ¨åŠ è½½...';
      }, 3000);
    } finally {
      this.isLoading = false;
    }
  }

  
  /**
   * æ„å»ºæ“ä½œæŒ‰é’®
   */
  @Builder
  ActionButton(icon: string, text: string, isPrimary: boolean, onClick: () => void) {
    Button() {
      Row() {
        Text(icon)
          .fontSize(24)
          .margin({ right: 10 })
        Text(text)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
    }
    .type(ButtonType.Capsule)
    .stateEffect(true)
    .width('90%')
    .height(56)
    .backgroundColor(isPrimary ? '#007DFF' : '#252525')
    .border(isPrimary ? undefined : { width: 1, color: '#007DFF', style: BorderStyle.Solid })
    .margin({ bottom: 15 })
    .enabled(!this.isLoading)
    .onClick(onClick)
  }

  
  build() {
    Stack() {
      // ä¸»å†…å®¹åŒºåŸŸ - å¯æ»šåŠ¨
      Scroll() {
        Column() {
          // é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ
          Column() {
            Text('AI æ™ºèƒ½æ•°æ®å¯è§†åŒ–åŠ©æ‰‹')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
              .margin({ top: 20, bottom: 12 })

            Text('ä¸Šä¼  CSV æ–‡ä»¶æˆ–æ‰‹åŠ¨è¾“å…¥æ•°æ®')
              .fontSize(14)
              .fontColor(Color.Gray)
              .textAlign(TextAlign.Center)
              .margin({ bottom: 4 })

            Text('å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡æ•°æ®å¯è§†åŒ–')
              .fontSize(14)
              .fontColor(Color.Gray)
              .textAlign(TextAlign.Center)
          }
          .width('100%')
          .padding({ left: 20, right: 20, bottom: 30 })
          .alignItems(HorizontalAlign.Center)

          // æ•°æ®è¾“å…¥æ“ä½œåŒº - ä¸‰ä¸ªä¸»è¦æ“ä½œæŒ‰é’®
          Column() {
            // ä¸Šä¼ æ•°æ®æŒ‰é’®ï¼ˆä¸»è‰²è°ƒï¼‰
            this.ActionButton('ğŸ“„', 'ä¸Šä¼ æ•°æ®', true, async () => {
              console.info('ç‚¹å‡»ä¸Šä¼ æ•°æ®');
              await this.handleFileUpload();
            })

            // æ‰‹åŠ¨è¾“å…¥æŒ‰é’®ï¼ˆæ·±è‰²èƒŒæ™¯ï¼Œäº®è‰²è¾¹æ¡†ï¼‰
            this.ActionButton('âœï¸', 'æ‰‹åŠ¨è¾“å…¥', false, () => {
              console.info('ç‚¹å‡»æ‰‹åŠ¨è¾“å…¥');
              router.pushUrl({
                url: 'pages/DataInputPage'
              }).catch((err: BusinessError) => {
                console.error('è·³è½¬åˆ°æ•°æ®è¾“å…¥é¡µé¢å¤±è´¥:', err);
              });
            })
          }
          .width('100%')
          .margin({ bottom: 30 })

          // ç¤ºä¾‹æ•°æ®åŒºåŸŸ
          Column() {
            Row() {
              Text('ç¤ºä¾‹æ•°æ®')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor(Color.White)
              Blank()
            }
            .width('100%')
            .margin({ bottom: 15 })

            // ç¤ºä¾‹æ•°æ®å¡ç‰‡
            Column() {
              Row() {
                Button('ğŸ“ˆ é”€å”®æ•°æ®')
                  .width('48%')
                  .height(80)
                  .backgroundColor('#252525')
                  .fontColor(Color.White)
                  .fontSize(14)
                  .margin({ right: '4%' })
                  .onClick(() => {
                    this.handleUseSampleData('sales');
                  })

                Button('ğŸŒ¤ï¸ å¤©æ°”æ•°æ®')
                  .width('48%')
                  .height(80)
                  .backgroundColor('#252525')
                  .fontColor(Color.White)
                  .fontSize(14)
                  .onClick(() => {
                    this.handleUseSampleData('weather');
                  })
              }
              .width('100%')
              .margin({ bottom: 12 })

              Button('ğŸ‘¨â€ğŸ“ å­¦ç”Ÿæˆç»©')
                .width('100%')
                .height(80)
                .backgroundColor('#252525')
                .fontColor(Color.White)
                .fontSize(14)
                .onClick(() => {
                  this.handleUseSampleData('students');
                })
            }
            .width('100%')
            .padding(15)
            .backgroundColor('#1C1C1C')
            .borderRadius(10)
          }
          .width('90%')
          .margin({ bottom: 20 })

          // åº•éƒ¨é—´è·ï¼Œç¡®ä¿å†…å®¹ä¸ä¼šè¢«é®æŒ¡
          Column()
            .height(100)
            .width('100%')
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
      .height('100%')
      .scrollable(ScrollDirection.Vertical) // æ˜ç¡®æŒ‡å®šå‚ç›´æ»šåŠ¨
      .scrollBar(BarState.Auto) // è‡ªåŠ¨æ˜¾ç¤ºæ»šåŠ¨æ¡
      .edgeEffect(EdgeEffect.Spring) // æ·»åŠ å¼¹æ€§æ•ˆæœ

      // åŠ è½½çŠ¶æ€æç¤ºï¼ˆè¦†ç›–åœ¨é¡¶å±‚ï¼‰
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .margin({ bottom: 10 })
          Text(this.loadingMessage)
            .fontSize(14)
            .fontColor(Color.Gray)
        }
        .width('100%')
        .padding(20)
        .backgroundColor('#1C1C1C')
        .position({ x: 0, y: '70%' }) // å›ºå®šåœ¨åº•éƒ¨ä½ç½®
      }

          }
    .width('100%')
    .height('100%')
    .backgroundColor('#1C1C1C')
  }
}