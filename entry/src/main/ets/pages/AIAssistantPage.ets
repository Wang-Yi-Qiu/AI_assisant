import router from '@ohos.router';
import { generateChart, ChartConfig, UserData } from '../utils/aiService';
import { loadSampleData, getSampleDataList, SampleDataset } from '../utils/sampleDataManager';
import { getSampleChartList, SampleChart } from '../utils/sampleChartManager';
import { setChartOption } from './ChartPage';
import { ErrorHandler } from '../utils/errorHandler';
import { getGlobalContext } from '../utils/sampleDataManager';
import { BusinessError } from '@kit.BasicServicesKit';

@Entry
@Component
export struct AIAssistantPage {
  @State isLoading: boolean = false;
  @State loadingMessage: string = 'æ­£åœ¨ç”Ÿæˆå›¾è¡¨...';
  @State sampleDataList: SampleDataset[] = getSampleDataList();
  @State sampleChartList: SampleChart[] = getSampleChartList();
  @State showSampleDataDialog: boolean = false;

  aboutToAppear() {
    // é¡µé¢åŠ è½½æ—¶èŽ·å–æ ·æœ¬æ•°æ®åˆ—è¡¨å’Œç¤ºä¾‹å›¾è¡¨åˆ—è¡¨
    this.sampleDataList = getSampleDataList();
    this.sampleChartList = getSampleChartList();
  }

  /**
   * ä½¿ç”¨ç¤ºä¾‹å›¾è¡¨
   */
  handleUseSampleChart(sampleChart: SampleChart) {
    console.info('[AIAssistantPage] ä½¿ç”¨ç¤ºä¾‹å›¾è¡¨:', sampleChart.id);
    setChartOption(sampleChart.chartConfig);
    router.pushNamedRoute({
      name: 'ChartPage'
    }).catch((err: BusinessError) => {
      console.error('è·³è½¬åˆ°å›¾è¡¨é¡µå¤±è´¥:', err);
    });
  }

  /**
   * ä½¿ç”¨ç¤ºä¾‹æ•°æ®ç”Ÿæˆå›¾è¡¨
   */
  async handleUseSampleData(sampleId: string) {
    if (this.isLoading) {
      return;
    }

    this.isLoading = true;
    this.loadingMessage = 'æ­£åœ¨åŠ è½½ç¤ºä¾‹æ•°æ®...';

    try {
      console.info('[AIAssistantPage] å¼€å§‹ä½¿ç”¨ç¤ºä¾‹æ•°æ®ç”Ÿæˆå›¾è¡¨:', sampleId);
      
      // 1. åŠ è½½ç¤ºä¾‹æ•°æ®
      const context = getGlobalContext();
      if (!context) {
        throw new Error('åº”ç”¨ä¸Šä¸‹æ–‡ä¸å¯ç”¨');
      }

      this.loadingMessage = 'æ­£åœ¨åŠ è½½ç¤ºä¾‹æ•°æ®...';
      const sampleDataJson = await loadSampleData(sampleId, context);
      console.info('[AIAssistantPage] ç¤ºä¾‹æ•°æ®åŠ è½½æˆåŠŸï¼Œé•¿åº¦:', sampleDataJson.length);

      // 2. è§£æžæ•°æ®
      let userData: UserData;
      try {
        userData = JSON.parse(sampleDataJson);
        console.info('[AIAssistantPage] æ•°æ®è§£æžæˆåŠŸ');
      } catch (parseError) {
        console.error('[AIAssistantPage] æ•°æ®è§£æžå¤±è´¥:', parseError);
        throw new Error('ç¤ºä¾‹æ•°æ®æ ¼å¼é”™è¯¯');
      }

      // 3. è°ƒç”¨ AI æœåŠ¡ç”Ÿæˆå›¾è¡¨é…ç½®
      this.loadingMessage = 'æ­£åœ¨è°ƒç”¨åƒé—®APIç”Ÿæˆå›¾è¡¨...';
      console.info('[AIAssistantPage] å¼€å§‹è°ƒç”¨ generateChart API');
      
      const chartConfig: ChartConfig = await generateChart(userData);
      console.info('[AIAssistantPage] å›¾è¡¨é…ç½®ç”ŸæˆæˆåŠŸ:', JSON.stringify(chartConfig).substring(0, 200));

      // 4. è®¾ç½®å›¾è¡¨é…ç½®å¹¶è·³è½¬
      setChartOption(chartConfig);
      console.info('[AIAssistantPage] å›¾è¡¨é…ç½®å·²è®¾ç½®ï¼Œå‡†å¤‡è·³è½¬');

      // 5. è·³è½¬åˆ°å›¾è¡¨é¡µé¢
      await router.pushNamedRoute({
        name: 'ChartPage'
      });
      
      console.info('[AIAssistantPage] å·²è·³è½¬åˆ°å›¾è¡¨é¡µé¢');
    } catch (error) {
      console.error('[AIAssistantPage] ç”Ÿæˆå›¾è¡¨å¤±è´¥:', error);
      const appError = ErrorHandler.handle(error, 'handleUseSampleData');
      
      // æ˜¾ç¤ºé”™è¯¯æç¤ºï¼ˆè¿™é‡Œå¯ä»¥æ·»åŠ  Toast æˆ– Dialogï¼‰
      this.loadingMessage = `ç”Ÿæˆå¤±è´¥: ${appError.userMessage}`;
      
      // å»¶è¿Ÿæ¸…é™¤é”™è¯¯æ¶ˆæ¯
      setTimeout(() => {
        this.loadingMessage = 'æ­£åœ¨ç”Ÿæˆå›¾è¡¨...';
      }, 3000);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * æž„å»ºæ“ä½œæŒ‰é’®
   */
  @Builder
  ActionButton(icon: string, text: string, isPrimary: boolean, onClick: () => void) {
    Button() {
      Row() {
        Text(icon)
          .fontSize(24)
          .margin({ right: 10 })
        Text(text)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
    }
    .type(ButtonType.Capsule)
    .stateEffect(true)
    .width('90%')
    .height(56)
    .backgroundColor(isPrimary ? '#007DFF' : '#252525')
    .border(isPrimary ? undefined : { width: 1, color: '#007DFF', style: BorderStyle.Solid })
    .margin({ bottom: 15 })
    .enabled(!this.isLoading)
    .onClick(onClick)
  }

  /**
   * æž„å»ºç¤ºä¾‹å›¾è¡¨å¡ç‰‡
   */
  @Builder
  SampleChartCard(sampleChart: SampleChart) {
    Column() {
      Text(sampleChart.icon)
        .fontSize(40)
        .margin({ bottom: 10 })
      Text(sampleChart.name)
        .fontSize(12)
        .fontColor(Color.Gray)
        .margin({ bottom: 4 })
      Text(sampleChart.description)
        .fontSize(10)
        .fontColor('#666666')
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .padding(10)
    .backgroundColor('#1C1C1C')
    .borderRadius(15)
    .onClick(() => {
      this.handleUseSampleChart(sampleChart);
    })
  }

  /**
   * æž„å»ºç¤ºä¾‹æ•°æ®é€‰æ‹©é¡¹
   */
  @Builder
  SampleDataItem(sample: SampleDataset) {
    Row() {
      Column() {
        Text(sample.name)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor(Color.White)
          .alignSelf(ItemAlign.Start)
        Text(sample.description)
          .fontSize(12)
          .fontColor(Color.Gray)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .alignSelf(ItemAlign.Start)
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      Text('â†’')
        .fontSize(20)
        .fontColor('#007DFF')
    }
    .width('100%')
    .padding(15)
    .backgroundColor('#252525')
    .borderRadius(10)
    .margin({ bottom: 10 })
    .onClick(() => {
      this.showSampleDataDialog = false;
      this.handleUseSampleData(sample.id);
    })
  }

  build() {
    Stack() {
      // ä¸»å†…å®¹åŒºåŸŸ - å¯æ»šåŠ¨
      Scroll() {
        Column() {
          // é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ
          Column() {
            Text('AI æ™ºèƒ½æ•°æ®å¯è§†åŒ–åŠ©æ‰‹')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
              .margin({ top: 20, bottom: 12 })

            Text('ä¸Šä¼  CSV æ–‡ä»¶æˆ–æ‰‹åŠ¨è¾“å…¥æ•°æ®')
              .fontSize(14)
              .fontColor(Color.Gray)
              .textAlign(TextAlign.Center)
              .margin({ bottom: 4 })

            Text('å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡æ•°æ®å¯è§†åŒ–')
              .fontSize(14)
              .fontColor(Color.Gray)
              .textAlign(TextAlign.Center)
          }
          .width('100%')
          .padding({ left: 20, right: 20, bottom: 30 })
          .alignItems(HorizontalAlign.Center)

          // æ•°æ®è¾“å…¥æ“ä½œåŒº - ä¸‰ä¸ªä¸»è¦æ“ä½œæŒ‰é’®
          Column() {
            // ä¸Šä¼ æ•°æ®æŒ‰é’®ï¼ˆä¸»è‰²è°ƒï¼‰
            this.ActionButton('ðŸ“„', 'ä¸Šä¼ æ•°æ®', true, () => {
              console.info('ç‚¹å‡»ä¸Šä¼ æ•°æ®');
              // TODO: å®žçŽ°æ–‡ä»¶é€‰æ‹©å™¨é€»è¾‘
            })

            // æ‰‹åŠ¨è¾“å…¥æŒ‰é’®ï¼ˆæ·±è‰²èƒŒæ™¯ï¼Œäº®è‰²è¾¹æ¡†ï¼‰
            this.ActionButton('âœï¸', 'æ‰‹åŠ¨è¾“å…¥', false, () => {
              console.info('ç‚¹å‡»æ‰‹åŠ¨è¾“å…¥');
              // TODO: å¯¼èˆªåˆ°æ•°æ®æ‰‹åŠ¨è¾“å…¥é¡µé¢
            })

            // ä½¿ç”¨ç¤ºä¾‹æ•°æ®æŒ‰é’®ï¼ˆæ·±è‰²èƒŒæ™¯ï¼Œäº®è‰²è¾¹æ¡†ï¼‰
            this.ActionButton('ðŸ“Š', 'ä½¿ç”¨ç¤ºä¾‹æ•°æ®', false, () => {
              console.info('ç‚¹å‡»ä½¿ç”¨ç¤ºä¾‹æ•°æ®');
              // æ˜¾ç¤ºç¤ºä¾‹æ•°æ®é€‰æ‹©å¯¹è¯æ¡†
              this.showSampleDataDialog = true;
            })
          }
          .width('100%')
          .margin({ bottom: 30 })

          // åŽ†å²å›¾è¡¨åŒº
          Column() {
            Row() {
              Text('åŽ†å²å›¾è¡¨')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor(Color.White)
              Blank()
            }
            .width('100%')
            .margin({ bottom: 15 })

            // ç¤ºä¾‹å›¾è¡¨ç½‘æ ¼å¸ƒå±€
            Grid() {
              ForEach(this.sampleChartList, (sampleChart: SampleChart) => {
                GridItem() {
                  this.SampleChartCard(sampleChart)
                }
              }, (sampleChart: SampleChart) => sampleChart.id)
            }
            .columnsTemplate('1fr 1fr')
            .rowsTemplate('1fr 1fr')
            .columnsGap(12)
            .rowsGap(12)
            .width('100%')
            .height(220)
          }
          .width('90%')
          .margin({ bottom: 20 })

          // åº•éƒ¨é—´è·ï¼Œç¡®ä¿å†…å®¹ä¸ä¼šè¢«é®æŒ¡
          Column()
            .height(100)
            .width('100%')
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
      .height('100%')
      .scrollable(ScrollDirection.Vertical) // æ˜Žç¡®æŒ‡å®šåž‚ç›´æ»šåŠ¨
      .scrollBar(BarState.Auto) // è‡ªåŠ¨æ˜¾ç¤ºæ»šåŠ¨æ¡
      .edgeEffect(EdgeEffect.Spring) // æ·»åŠ å¼¹æ€§æ•ˆæžœ

      // åŠ è½½çŠ¶æ€æç¤ºï¼ˆè¦†ç›–åœ¨é¡¶å±‚ï¼‰
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .margin({ bottom: 10 })
          Text(this.loadingMessage)
            .fontSize(14)
            .fontColor(Color.Gray)
        }
        .width('100%')
        .padding(20)
        .backgroundColor('#1C1C1C')
        .position({ x: 0, y: '70%' }) // å›ºå®šåœ¨åº•éƒ¨ä½ç½®
      }

      // ç¤ºä¾‹æ•°æ®é€‰æ‹©å¯¹è¯æ¡†ï¼ˆè¦†ç›–åœ¨é¡¶å±‚ï¼‰
      if (this.showSampleDataDialog) {
        Stack() {
          // èƒŒæ™¯é®ç½©
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0, 0, 0, 0.5)')
            .onClick(() => {
              this.showSampleDataDialog = false;
            })

          // å¯¹è¯æ¡†å†…å®¹
          Column() {
            // æ ‡é¢˜æ 
            Row() {
              Text('é€‰æ‹©ç¤ºä¾‹æ•°æ®')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor(Color.White)
              Blank()
              Text('âœ•')
                .fontSize(24)
                .fontColor(Color.Gray)
                .onClick(() => {
                  this.showSampleDataDialog = false;
                })
            }
            .width('100%')
            .padding(15)
            .border({ width: 0, color: Color.Transparent })

            Divider()
              .color('#333333')

            // ç¤ºä¾‹æ•°æ®åˆ—è¡¨
            Scroll() {
              Column() {
                ForEach(this.sampleDataList, (sample: SampleDataset) => {
                  this.SampleDataItem(sample)
                }, (sample: SampleDataset) => sample.id)
              }
              .width('100%')
              .padding(15)
            }
            .layoutWeight(1)
            .width('100%')
          }
          .width('90%')
          .height('70%')
          .backgroundColor('#252525')
          .borderRadius(15)
          .alignSelf(ItemAlign.Center)
        }
        .width('100%')
        .height('100%')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#1C1C1C')
  }
}