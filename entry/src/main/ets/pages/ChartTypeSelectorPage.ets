/**
 * å›¾è¡¨ç±»å‹é€‰æ‹©é¡µé¢
 * æ”¯æŒå¤šç§å›¾è¡¨ç±»å‹çš„é€‰æ‹©å’Œé¢„è§ˆ
 * @module ChartTypeSelectorPage
 */

import router from '@ohos.router';
import { getOriginalData, setChartOption } from './ChartPage';
import { generateChart, ChartConfig, UserData, CSVData } from '../utils/aiService';

// è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨åœ°è®¿é—®UserDataçš„dataå±æ€§
function getDataFromUserData(userData: UserData): object[] | null {
  if (typeof userData === 'object' && userData !== null) {
    const csvData = userData as CSVData;
    return csvData.data || null;
  }
  return null;
}

// å›¾è¡¨ç±»å‹å®šä¹‰
export interface ChartType {
  id: string;
  name: string;
  description: string;
  icon: string;
  example: string;
  supported: boolean;
}

@Entry
@Component
export struct ChartTypeSelectorPage {
  @State chartTypes: ChartType[] = [];
  @State selectedType: string = '';
  @State isLoading: boolean = false;

  aboutToAppear(): void {
    console.info('[ChartTypeSelectorPage] é¡µé¢åˆå§‹åŒ–');
    this.initializeChartTypes();
  }

  /**
   * åˆå§‹åŒ–å›¾è¡¨ç±»å‹åˆ—è¡¨
   */
  initializeChartTypes(): void {
    this.chartTypes = [
      {
        id: 'bar',
        name: 'æŸ±çŠ¶å›¾',
        description: 'é€‚åˆæ¯”è¾ƒä¸åŒç±»åˆ«çš„æ•°å€¼å¤§å°',
        icon: 'ğŸ“Š',
        example: 'æœˆåº¦é”€å”®é¢å¯¹æ¯”',
        supported: true
      },
      {
        id: 'line',
        name: 'æŠ˜çº¿å›¾',
        description: 'é€‚åˆå±•ç¤ºæ•°æ®éšæ—¶é—´çš„å˜åŒ–è¶‹åŠ¿',
        icon: 'ğŸ“ˆ',
        example: 'è‚¡ç¥¨ä»·æ ¼èµ°åŠ¿',
        supported: true
      },
      {
        id: 'pie',
        name: 'é¥¼å›¾',
        description: 'é€‚åˆå±•ç¤ºæ•°æ®çš„å æ¯”å…³ç³»',
        icon: 'ğŸ¥§',
        example: 'å¸‚åœºä»½é¢åˆ†å¸ƒ',
        supported: true
      },
      {
        id: 'scatter',
        name: 'æ•£ç‚¹å›¾',
        description: 'é€‚åˆå±•ç¤ºä¸¤ä¸ªå˜é‡ä¹‹é—´çš„å…³ç³»',
        icon: 'âš¡',
        example: 'èº«é«˜ä½“é‡å…³ç³»',
        supported: true
      },
      {
        id: 'area',
        name: 'é¢ç§¯å›¾',
        description: 'é€‚åˆå±•ç¤ºæ•°æ®çš„ç´¯ç§¯å˜åŒ–',
        icon: 'ğŸ“‰',
        example: 'ç”¨æˆ·å¢é•¿è¶‹åŠ¿',
        supported: true
      },
      {
        id: 'radar',
        name: 'é›·è¾¾å›¾',
        description: 'é€‚åˆå¤šç»´åº¦æ•°æ®çš„å¯¹æ¯”åˆ†æ',
        icon: 'ğŸ¯',
        example: 'äº§å“èƒ½åŠ›è¯„ä¼°',
        supported: true
      }
    ];
    console.info('[ChartTypeSelectorPage] å›¾è¡¨ç±»å‹åˆå§‹åŒ–å®Œæˆï¼Œå…±', this.chartTypes.length, 'ç§');
  }

  /**
   * é€‰æ‹©å›¾è¡¨ç±»å‹
   */
  selectChartType(chartType: ChartType): void {
    if (!chartType.supported) {
      console.warn('[ChartTypeSelectorPage] å›¾è¡¨ç±»å‹ä¸æ”¯æŒ:', chartType.id);
      return;
    }

    this.selectedType = chartType.id;
    console.info('[ChartTypeSelectorPage] é€‰æ‹©å›¾è¡¨ç±»å‹:', chartType.id, chartType.name);
  }

  /**
   * ç¡®è®¤é€‰æ‹©å¹¶ç”Ÿæˆå›¾è¡¨
   */
  async confirmSelection(): Promise<void> {
    if (!this.selectedType || this.isLoading) {
      return;
    }

    try {
      console.info('[ChartTypeSelectorPage] ========== å¼€å§‹ç”Ÿæˆ', this.selectedType, 'å›¾è¡¨ ==========');

      // æ£€æŸ¥æ˜¯å¦æœ‰åŸå§‹æ•°æ®
      const originalData = getOriginalData();
      if (!originalData) {
        throw new Error('æ²¡æœ‰åŸå§‹æ•°æ®ç”¨äºç”Ÿæˆå›¾è¡¨');
      }
      const dataRows = getDataFromUserData(originalData);
      if (!dataRows || dataRows.length === 0) {
        throw new Error('æ²¡æœ‰åŸå§‹æ•°æ®ç”¨äºç”Ÿæˆå›¾è¡¨');
      }

      console.info('[ChartTypeSelectorPage] ä½¿ç”¨æ•°æ®ç”Ÿæˆ', this.selectedType, 'å›¾è¡¨');

      this.isLoading = true;

      // æ„å»ºåŒ…å«å›¾è¡¨ç±»å‹çš„ç”¨æˆ·æ•°æ®
      const newUserData: Record<string, object> = {};
      if (typeof originalData === 'object' && originalData !== null) {
        // æ‰‹åŠ¨å¤åˆ¶å±æ€§
        const keys = Object.keys(originalData);
        for (let i = 0; i < keys.length; i++) {
          const key = keys[i];
          const value = (originalData as Record<string, object>)[key];
          if (value !== undefined) {
            newUserData[key] = value;
          }
        }
      }
      newUserData.chartType = this.selectedType;
      const userData: UserData = newUserData;

      // è°ƒç”¨AIæœåŠ¡ç”Ÿæˆå›¾è¡¨é…ç½®
      const chartConfig: ChartConfig = await generateChart(userData);
      console.info('[ChartTypeSelectorPage] å›¾è¡¨é…ç½®ç”ŸæˆæˆåŠŸ');

      // è®¾ç½®å›¾è¡¨é…ç½®
      setChartOption(chartConfig, userData);
      console.info('[ChartTypeSelectorPage] å›¾è¡¨é…ç½®å·²è®¾ç½®ï¼Œå‡†å¤‡è·³è½¬');

      // è·³è½¬åˆ°å›¾è¡¨é¡µé¢
      await router.pushUrl({
        url: 'pages/ChartPage'
      });

      console.info('[ChartTypeSelectorPage] å·²è·³è½¬åˆ°å›¾è¡¨é¡µé¢');

    } catch (error) {
      console.error('[ChartTypeSelectorPage] ç”Ÿæˆå›¾è¡¨å¤±è´¥:', error);

      // æ˜¾ç¤ºé”™è¯¯æç¤º
      // è¿™é‡Œå¯ä»¥æ·»åŠ Toastæˆ–Dialogæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      console.error('ç”Ÿæˆå¤±è´¥:', error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯');

    } finally {
      this.isLoading = false;
    }
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  goBack(): void {
    router.back();
  }

  /**
   * æ„å»ºå›¾è¡¨ç±»å‹å¡ç‰‡
   */
  @Builder
  ChartTypeCard(chartType: ChartType): void {
    Column() {
      // å›¾æ ‡
      Text(chartType.icon)
        .fontSize(40)
        .margin({ bottom: 12 })

      // åç§°
      Text(chartType.name)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.White)
        .margin({ bottom: 6 })

      // æè¿°
      Text(chartType.description)
        .fontSize(12)
        .fontColor(Color.Gray)
        .textAlign(TextAlign.Center)
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .margin({ bottom: 8 })

      // ç¤ºä¾‹
      Text(chartType.example)
        .fontSize(10)
        .fontColor('#666666')
        .fontStyle(FontStyle.Italic)

      // æ”¯æŒçŠ¶æ€
      if (!chartType.supported) {
        Text('å¼€å‘ä¸­')
          .fontSize(10)
          .fontColor('#FFA500')
          .margin({ top: 8 })
      }
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .padding(15)
    .backgroundColor(this.selectedType === chartType.id ? '#007DFF' : '#252525')
    .borderRadius(12)
    .border({
      width: 2,
      color: this.selectedType === chartType.id ? '#007DFF' : '#333333'
    })
    .onClick(() => {
      this.selectChartType(chartType);
    })
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(24)
            .fontColor(Color.White)
        }
        .type(ButtonType.Normal)
        .backgroundColor(Color.Transparent)
        .width(40)
        .height(40)
        .onClick(() => {
          this.goBack();
        })

        Blank()

        Text('é€‰æ‹©å›¾è¡¨ç±»å‹')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)

        Blank()
          .width(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 15, right: 15 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)
      .backgroundColor('#1C1C1C')

      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // è¯´æ˜æ–‡å­—
          Text('é€‰æ‹©æœ€é€‚åˆæ‚¨æ•°æ®çš„å›¾è¡¨ç±»å‹')
            .fontSize(16)
            .fontColor(Color.White)
            .margin({ top: 20, bottom: 10 })
            .textAlign(TextAlign.Center)

          Text('ç³»ç»Ÿå°†æ ¹æ®æ‚¨çš„é€‰æ‹©å’Œæ•°æ®ç‰¹ç‚¹æ™ºèƒ½ç”Ÿæˆå›¾è¡¨')
            .fontSize(12)
            .fontColor(Color.Gray)
            .margin({ bottom: 30 })
            .textAlign(TextAlign.Center)

          // å›¾è¡¨ç±»å‹ç½‘æ ¼
          Grid() {
            ForEach(this.chartTypes, (chartType: ChartType, index?: number) => {
              GridItem() {
                this.ChartTypeCard(chartType)
              }
            }, (chartType: ChartType, index?: number) => chartType.id)
          }
          .columnsTemplate('1fr 1fr')
          .rowsTemplate('1fr 1fr 1fr')
          .columnsGap(15)
          .rowsGap(15)
          .width('90%')
          .height(400)

          // ç¡®è®¤æŒ‰é’®
          Button(this.selectedType ? 'ç”Ÿæˆå›¾è¡¨' : 'è¯·é€‰æ‹©å›¾è¡¨ç±»å‹')
            .width('80%')
            .height(50)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .backgroundColor(this.selectedType ? '#007DFF' : '#666666')
            .fontColor(Color.White)
            .borderRadius(25)
            .enabled(this.selectedType !== '' && !this.isLoading)
            .margin({ top: 40, bottom: 30 })
            .onClick(() => {
              this.confirmSelection();
            })
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
        .padding({ top: 20, bottom: 20 })
      }
      .layoutWeight(1)
      .width('100%')

      // åŠ è½½çŠ¶æ€æç¤º
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .margin({ bottom: 10 })
          Text('æ­£åœ¨ç”Ÿæˆå›¾è¡¨...')
            .fontSize(14)
            .fontColor(Color.Gray)
        }
        .width('100%')
        .padding(20)
        .backgroundColor('#1C1C1C')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#1C1C1C')
  }
}