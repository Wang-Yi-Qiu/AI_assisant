/**
 * æ™ºèƒ½å›¾è¡¨é€‰æ‹©é¡µé¢
 * åŸºäºæœ¬åœ°AIç®—æ³•æ¨èæœ€é€‚åˆçš„å›¾è¡¨ç±»å‹
 * æä¾›è¯¦ç»†çš„æ¨èç†ç”±å’Œé…ç½®é€‰é¡¹
 */

import router from '@ohos.router';
import { LocalChartService, LocalChartData, ChartRecommendation, ExportFormat } from '../utils/localChartService';
import { ChartConfigFactory, ChartType } from '../chart/config/ChartConfigFactory';
import { ChartTheme } from '../chart/config/ChartTheme';
import { dataVisualizationService, FieldInfo } from '../utils/dataVisualizationService';
import { fileDataParser, ParsedData } from '../utils/fileDataParser';

@Entry
@Component
export struct SmartChartSelectorPage {
  @State parsedData: ParsedData | null = null;
  @State localChartData: LocalChartData | null = null;
  @State recommendations: ChartRecommendation[] = [];
  @State selectedChartType: string = '';
  @State isLoading: boolean = false;
  @State showAdvancedOptions: boolean = false;
  @State selectedTheme: ChartTheme = new ChartTheme('dark');
  @State enableAnimation: boolean = true;
  @State showDataLabels: boolean = false;
  @State customTitle: string = '';
  @State customSubtitle: string = '';

  private localChartService: LocalChartService = LocalChartService.getInstance();

  aboutToAppear(): void {
    console.info('[SmartChartSelectorPage] é¡µé¢åˆå§‹åŒ–');
    this.initializeData();
  }

  /**
   * åˆå§‹åŒ–æ•°æ®
   */
  private async initializeData(): Promise<void> {
    try {
      const params = router.getParams() as any;
      if (params && params.parsedData) {
        this.parsedData = params.parsedData as ParsedData;

        // è½¬æ¢ä¸ºLocalChartData
        this.localChartData = this.convertParsedDataToLocal(this.parsedData);

        // ç”Ÿæˆæ™ºèƒ½æ¨è
        if (this.localChartData) {
          this.recommendations = this.localChartService.recommendChartTypes(this.localChartData);
          if (this.recommendations.length > 0) {
            this.selectedChartType = this.recommendations[0].type;
          }
        }

        console.info('[SmartChartSelectorPage] æ•°æ®åˆå§‹åŒ–å®Œæˆ');
      }
    } catch (error) {
      console.error('[SmartChartSelectorPage] æ•°æ®åˆå§‹åŒ–å¤±è´¥:', error);
    }
  }

  /**
   * è½¬æ¢ParsedDataä¸ºLocalChartData
   */
  private convertParsedDataToLocal(parsedData: ParsedData): LocalChartData {
    const numericColumns: number[] = [];
    const categoryColumns: number[] = [];

    // åˆ†ææ•°æ®ç±»å‹
    for (let i = 0; i < parsedData.headers.length; i++) {
      const values = parsedData.data.map(row => row[parsedData.headers[i]]);
      const numericCount = values.filter(val => !isNaN(Number(val))).length;

      if (numericCount / values.length > 0.7) {
        numericColumns.push(i);
      } else {
        categoryColumns.push(i);
      }
    }

    return {
      headers: parsedData.headers,
      rows: parsedData.data.map(row => parsedData.headers.map(header => String(row[header]))),
      numericColumns,
      categoryColumns
    };
  }

  /**
   * è·å–ç½®ä¿¡åº¦é¢œè‰²
   */
  private getConfidenceColor(confidence: 'high' | 'medium' | 'low'): string {
    switch (confidence) {
      case 'high': return '#00C853';
      case 'medium': return '#FF9800';
      case 'low': return '#F44336';
      default: return '#757575';
    }
  }

  /**
   * è·å–ç½®ä¿¡åº¦æ–‡æœ¬
   */
  private getConfidenceText(confidence: 'high' | 'medium' | 'low'): string {
    switch (confidence) {
      case 'high': return 'é«˜ç½®ä¿¡åº¦';
      case 'medium': return 'ä¸­ç­‰ç½®ä¿¡åº¦';
      case 'low': return 'ä½ç½®ä¿¡åº¦';
      default: return 'æœªçŸ¥';
    }
  }

  /**
   * è·å–å›¾è¡¨ç±»å‹åç§°
   */
  private getChartTypeName(type: string): string {
    const names: Record<string, string> = {
      'bar': 'æŸ±çŠ¶å›¾',
      'line': 'æŠ˜çº¿å›¾',
      'pie': 'é¥¼å›¾',
      'scatter': 'æ•£ç‚¹å›¾'
    };
    return names[type] || type;
  }

  /**
   * ç”Ÿæˆå¹¶æ˜¾ç¤ºå›¾è¡¨ï¼ˆä½¿ç”¨å·¥å‚æ¨¡å¼ï¼‰
   */
  private async generateChart(): Promise<void> {
    if (!this.localChartData || !this.selectedChartType) {
      console.error('[SmartChartSelectorPage] æ•°æ®æˆ–å›¾è¡¨ç±»å‹æœªé€‰æ‹©');
      return;
    }

    try {
      this.isLoading = true;
      console.info('[SmartChartSelectorPage] å¼€å§‹ç”Ÿæˆå›¾è¡¨:', this.selectedChartType);

      // ä½¿ç”¨å·¥å‚æ¨¡å¼ç”Ÿæˆå›¾è¡¨é…ç½®
      const chartConfig = ChartConfigFactory.createChartConfig(
        this.selectedChartType as ChartType,
        this.localChartData,
        {
          theme: this.selectedTheme,
          animation: this.enableAnimation,
          dataLabels: this.showDataLabels,
          title: this.customTitle || undefined,
          subtitle: this.customSubtitle || undefined
        }
      );

      // ç”ŸæˆEChartsé…ç½®
      const eChartsConfig = chartConfig.generateConfig();

      // æ„å»ºå›¾è¡¨æ•°æ®åŒ…
      const chartData = {
        ...this.localChartData,
        eChartsConfig: eChartsConfig,
        chartType: this.selectedChartType,
        theme: this.selectedTheme.name
      };

      console.info('[SmartChartSelectorPage] å·¥å‚æ¨¡å¼å›¾è¡¨é…ç½®ç”Ÿæˆå®Œæˆ');

      // è·³è½¬åˆ°å›¾è¡¨æ˜¾ç¤ºé¡µé¢
      await router.pushUrl({
        url: 'pages/LocalChartPage',
        params: {
          'chartData': JSON.stringify(chartData)
        }
      });

    } catch (error) {
      console.error('[SmartChartSelectorPage] å›¾è¡¨ç”Ÿæˆå¤±è´¥:', error);
      // æä¾›å‹å¥½çš„é”™è¯¯æç¤º
      console.error('[SmartChartSelectorPage] é”™è¯¯è¯¦æƒ…:', error instanceof Error ? error.message : String(error));
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    Scroll() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          Button() {
            Text('â†')
              .fontSize(24)
              .fontColor(Color.White)
          }
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .width(40)
          .height(40)
          .onClick(() => {
            router.back();
          })

          Blank()

          Text('æ™ºèƒ½å›¾è¡¨é€‰æ‹©')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)

          Blank()
            .width(40)
        }
        .width('100%')
        .height(56)
        .padding({ left: 15, right: 15 })
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(VerticalAlign.Center)
        .backgroundColor('#1C1C1C')

        // æ•°æ®é¢„è§ˆå¡ç‰‡
        if (this.parsedData) {
          Column() {
            Row() {
              Text('æ•°æ®é¢„è§ˆ')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor(Color.White)
              Blank()
              Text(`${this.parsedData.rowCount} è¡Œ Ã— ${this.parsedData.columnCount} åˆ—`)
                .fontSize(14)
                .fontColor(Color.Gray)
            }
            .width('100%')
            .margin({ bottom: 15 })

            // è¡¨æ ¼é¢„è§ˆ
            Column() {
              // è¡¨å¤´
              Row() {
                ForEach(this.parsedData.headers.slice(0, 4), (header: string) => {
                  Text(header)
                    .fontSize(12)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#007DFF')
                    .layoutWeight(1)
                    .textAlign(TextAlign.Center)
                })
              }
              .width('100%')
              .padding({ vertical: 8 })
              .backgroundColor('#252525')
              .borderRadius({ topLeft: 8, topRight: 8 })

              // æ•°æ®è¡Œï¼ˆåªæ˜¾ç¤ºå‰3è¡Œï¼‰
              ForEach(this.parsedData.data.slice(0, 3), (row: Record<string, Object>) => {
                Row() {
                  ForEach(this.parsedData!.headers.slice(0, 4), (header: string) => {
                    Text(String(row[header]))
                      .fontSize(11)
                      .fontColor(Color.White)
                      .layoutWeight(1)
                      .textAlign(TextAlign.Center)
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                  })
                }
                .width('100%')
                .padding({ vertical: 6 })
                .backgroundColor('#2A2A2A')
              })

              if (this.parsedData.data.length > 3) {
                Row() {
                  Text(`... è¿˜æœ‰ ${this.parsedData.data.length - 3} è¡Œæ•°æ®`)
                    .fontSize(12)
                    .fontColor(Color.Gray)
                    .textAlign(TextAlign.Center)
                    .width('100%')
                }
                .width('100%')
                .padding({ vertical: 6 })
                .backgroundColor('#2A2A2A')
                .borderRadius({ bottomLeft: 8, bottomRight: 8 })
              }
            }
            .width('100%')
          }
          .width('90%')
          .padding(20)
          .backgroundColor('#252525')
          .borderRadius(15)
          .margin({ top: 20, bottom: 20 })
        }

        // AIæ¨èç»“æœ
        Column() {
          Row() {
            Text('ğŸ¤– AIæ™ºèƒ½æ¨è')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
            Blank()
            Text(`åŸºäºæ•°æ®ç‰¹å¾åˆ†æ`)
              .fontSize(12)
              .fontColor(Color.Gray)
          }
          .width('100%')
          .margin({ bottom: 15 })

          // æ¨èåˆ—è¡¨
          ForEach(this.recommendations, (recommendation: ChartRecommendation, index: number) => {
            Column() {
              Row() {
                // å›¾è¡¨ç±»å‹é€‰æ‹©
                Row() {
                  Radio({ value: recommendation.type, group: 'chartType' })
                    .checked(this.selectedChartType === recommendation.type)
                    .onChange(() => {
                      this.selectedChartType = recommendation.type;
                    })
                    .margin({ right: 10 })

                  Text(this.getChartTypeName(recommendation.type))
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(Color.White)
                }

                Blank()

                // ç½®ä¿¡åº¦æ ‡ç­¾
                Row() {
                  Text(this.getConfidenceText(recommendation.confidence))
                    .fontSize(12)
                    .fontColor(this.getConfidenceColor(recommendation.confidence))
                    .margin({ right: 5 })

                  Circle({ width: 8, height: 8 })
                    .fill(this.getConfidenceColor(recommendation.confidence))
                }
              }
              .width('100%')
              .alignItems(VerticalAlign.Center)
              .margin({ bottom: 8 })

              // æ¨èç†ç”±
              Text(recommendation.reason)
                .fontSize(14)
                .fontColor('#CCCCCC')
                .width('100%')
                .margin({ bottom: 8 })

              // è¯„åˆ†æ¡
              Row() {
                Text('åŒ¹é…åº¦')
                  .fontSize(12)
                  .fontColor(Color.Gray)
                  .margin({ right: 10 })

                Progress({
                  value: recommendation.score * 100,
                  total: 100,
                  type: ProgressType.Linear
                })
                  .width(100)
                  .height(6)
                  .color(this.getConfidenceColor(recommendation.confidence))
                  .backgroundColor('#333333')

                Text(`${Math.round(recommendation.score * 100)}%`)
                  .fontSize(12)
                  .fontColor(Color.White)
                  .margin({ left: 10 })
              }
              .width('100%')
              .alignItems(VerticalAlign.Center)
            }
            .width('100%')
            .padding(15)
            .backgroundColor(this.selectedChartType === recommendation.type ? '#2A2A2A' : '#1C1C1C')
            .borderRadius(10)
            .border({
              width: 2,
              color: this.selectedChartType === recommendation.type ? '#007DFF' : 'transparent'
            })
            .margin({ bottom: 10 })
            .onClick(() => {
              this.selectedChartType = recommendation.type;
            })
          })
        }
        .width('90%')
        .padding(20)
        .backgroundColor('#252525')
        .borderRadius(15)
        .margin({ bottom: 20 })

        // é«˜çº§é€‰é¡¹
        Column() {
          Row() {
            Text('é«˜çº§é€‰é¡¹')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
            Blank()
            Button(this.showAdvancedOptions ? 'æ”¶èµ·' : 'å±•å¼€')
              .fontSize(14)
              .fontColor('#007DFF')
              .backgroundColor(Color.Transparent)
              .onClick(() => {
                this.showAdvancedOptions = !this.showAdvancedOptions;
              })
          }
          .width('100%')
          .margin({ bottom: 15 })

          if (this.showAdvancedOptions) {
            Column() {
              // ä¸»é¢˜é€‰æ‹©
              Row() {
                Text('ä¸»é¢˜é…è‰²')
                  .fontSize(14)
                  .fontColor(Color.White)
                  .width(80)

                Row() {
                  Button('æ·±è‰²')
                    .fontSize(12)
                    .backgroundColor(this.selectedTheme.name === 'dark' ? '#007DFF' : '#333333')
                    .fontColor(Color.White)
                    .margin({ right: 8 })
                    .onClick(() => {
                      this.selectedTheme = new ChartTheme('dark');
                    })

                  Button('æµ…è‰²')
                    .fontSize(12)
                    .backgroundColor(this.selectedTheme.name === 'light' ? '#007DFF' : '#333333')
                    .fontColor(Color.White)
                    .margin({ right: 8 })
                    .onClick(() => {
                      this.selectedTheme = new ChartTheme('light');
                    })

                  Button('è“è‰²')
                    .fontSize(12)
                    .backgroundColor(this.selectedTheme.name === 'blue' ? '#007DFF' : '#333333')
                    .fontColor(Color.White)
                    .onClick(() => {
                      this.selectedTheme = new ChartTheme('blue');
                    })
                }
                .layoutWeight(1)
              }
              .width('100%')
              .margin({ bottom: 15 })

              // åŠ¨ç”»é€‰é¡¹
              Row() {
                Text('åŠ¨ç”»æ•ˆæœ')
                  .fontSize(14)
                  .fontColor(Color.White)
                  .width(80)

                Toggle({ type: ToggleType.Switch, isOn: this.enableAnimation })
                  .onChange((isOn: boolean) => {
                    this.enableAnimation = isOn;
                  })
              }
              .width('100%')
              .justifyContent(FlexAlign.SpaceBetween)
              .margin({ bottom: 15 })

              // æ•°æ®æ ‡ç­¾
              Row() {
                Text('æ˜¾ç¤ºæ•°æ®æ ‡ç­¾')
                  .fontSize(14)
                  .fontColor(Color.White)
                  .width(80)

                Toggle({ type: ToggleType.Switch, isOn: this.showDataLabels })
                  .onChange((isOn: boolean) => {
                    this.showDataLabels = isOn;
                  })
              }
              .width('100%')
              .justifyContent(FlexAlign.SpaceBetween)
              .margin({ bottom: 15 })

              // è‡ªå®šä¹‰æ ‡é¢˜
              Column() {
                Text('å›¾è¡¨æ ‡é¢˜')
                  .fontSize(14)
                  .fontColor(Color.White)
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 8 })

                TextInput({ placeholder: 'è¾“å…¥è‡ªå®šä¹‰æ ‡é¢˜...', text: this.customTitle })
                  .onChange((value: string) => {
                    this.customTitle = value;
                  })
                  .width('100%')
                  .height(40)
                  .backgroundColor('#333333')
                  .fontColor(Color.White)
                  .placeholderColor(Color.Gray)
                  .borderRadius(8)
              }
              .width('100%')
            }
            .width('100%')
            .padding(15)
            .backgroundColor('#1C1C1C')
            .borderRadius(8)
          }
        }
        .width('90%')
        .padding(20)
        .backgroundColor('#252525')
        .borderRadius(15)
        .margin({ bottom: 30 })

        // ç”ŸæˆæŒ‰é’®
        Button(this.isLoading ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆå›¾è¡¨')
          .width('90%')
          .height(50)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .backgroundColor('#007DFF')
          .fontColor(Color.White)
          .borderRadius(25)
          .enabled(!this.isLoading && this.selectedChartType !== '')
          .onClick(() => {
            this.generateChart();
          })

        // åº•éƒ¨é—´è·
        Column()
          .height(100)
      }
      .width('100%')
      .padding({ left: 15, right: 15, bottom: 20 })
    }
    .scrollable(ScrollDirection.Vertical)
    .scrollBar(BarState.Off)
    .backgroundColor('#1C1C1C')
    .height('100%')

    // åŠ è½½çŠ¶æ€æç¤º
    if (this.isLoading) {
      Column() {
        LoadingProgress()
          .width(40)
          .height(40)
          .margin({ bottom: 10 })
        Text('æ­£åœ¨æ™ºèƒ½ç”Ÿæˆå›¾è¡¨é…ç½®...')
          .fontSize(14)
          .fontColor(Color.Gray)
      }
      .width('100%')
      .padding(20)
      .backgroundColor('rgba(28, 28, 28, 0.9)')
    }
  }
}