import router from '@ohos.router';
import { PomodoroTimerService, PomodoroState } from '../utils/pomodoroTimerService';
import { getStorageInstance } from '../utils/preferencesStorage';
import { TaskManager } from '../utils/taskManager';
import common from '@ohos.app.ability.common';

/**
 * è·¯ç”±å‚æ•°æ¥å£
 */
interface RouterParams {
  selectedTaskId?: number;
  selectedTaskText?: string;
}

@Entry
@Component
struct FocusProgressPage {
  private pomodoroTimer: PomodoroTimerService = PomodoroTimerService.getInstance();
  private taskManager: TaskManager = TaskManager.getInstance();

  @State timerValue: number = 25 * 60; // 25åˆ†é’Ÿ
  @State isPaused: boolean = false;
  @State currentTask: string = "å‡†å¤‡å¼€å§‹ä¸“æ³¨"; // å½“å‰ä»»åŠ¡
  @State currentProgress: number = 0;
  @State currentTimerState: PomodoroState = PomodoroState.IDLE;
  @State showSkipConfirmDialog: boolean = false; // è·³è¿‡ç¡®è®¤å¯¹è¯æ¡†
  @State skipDialogTitle: string = ''; // å¯¹è¯æ¡†æ ‡é¢˜
  @State skipDialogContent: string = ''; // å¯¹è¯æ¡†å†…å®¹

  aboutToAppear() {
    // è®¾ç½®å­˜å‚¨Context
    const context = getContext(this) as common.UIAbilityContext;
    getStorageInstance().setContext(context);

    // è·å–è·¯ç”±å‚æ•°ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
    const params = router.getParams() as RouterParams;

    this.initializeTasks(params);
    this.initializeTimer();
  }

  aboutToDisappear() {
    try {
      // ç¡®ä¿å®šæ—¶å™¨è¢«æ­£ç¡®æ¸…ç†
      if (this.pomodoroTimer.isTimerActive()) {
        console.warn('FocusProgressPage: Timer is still active, cleaning up');
      }
      this.pomodoroTimer.destroy();
      console.info('FocusProgressPage: About to disappear, resources cleaned up');
    } catch (error) {
      console.error('FocusProgressPage: Error during cleanup', error);
      // å³ä½¿å‡ºé”™ä¹Ÿè¦å¼ºåˆ¶æ¸…ç†
      try {
        this.pomodoroTimer.forceCleanup();
      } catch (cleanupError) {
        console.error('FocusProgressPage: Force cleanup failed', cleanupError);
      }
    }
  }

  private async initializeTasks(params?: RouterParams): Promise<void> {
    try {
      await this.taskManager.initialize();

      // ä¼˜å…ˆä½¿ç”¨ä»ä¸»é¡µé¢ä¼ é€’è¿‡æ¥çš„ä»»åŠ¡
      if (params && params.selectedTaskId && params.selectedTaskText) {
        // éªŒè¯ä¼ é€’çš„ä»»åŠ¡IDæ˜¯å¦ä»ç„¶æœ‰æ•ˆï¼ˆæœªå®Œæˆï¼‰
        const selectedTask = this.taskManager.getTasks().find(task =>
          task.id === params.selectedTaskId && !task.completed
        );

        if (selectedTask && selectedTask.text === params.selectedTaskText) {
          this.currentTask = params.selectedTaskText;
          this.pomodoroTimer.setCurrentTask(params.selectedTaskText);
          console.info(`FocusProgressPage: Using passed task: ${params.selectedTaskText}`);
        } else {
          console.warn('FocusProgressPage: Passed task is invalid or completed, using fallback');
          this.setFallbackTask();
        }
      } else {
        // æ²¡æœ‰ä¼ é€’å‚æ•°æˆ–å‚æ•°æ— æ•ˆæ—¶ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæœªå®Œæˆçš„ä»»åŠ¡
        console.info('FocusProgressPage: No valid parameters, using first incomplete task');
        this.setFallbackTask();
      }
    } catch (error) {
      console.error('FocusProgressPage: Failed to initialize tasks', error);
      this.currentTask = "å‡†å¤‡å¼€å§‹ä¸“æ³¨";
      this.pomodoroTimer.setCurrentTask("å‡†å¤‡å¼€å§‹ä¸“æ³¨");
    }
  }

  /**
   * è®¾ç½®å¤‡ç”¨ä»»åŠ¡
   */
  private setFallbackTask(): void {
    const incompleteTasks = this.taskManager.getIncompleteTasks();
    if (incompleteTasks.length > 0) {
      this.currentTask = incompleteTasks[0].text;
      this.pomodoroTimer.setCurrentTask(incompleteTasks[0].text);
      console.info(`FocusProgressPage: Using fallback task: ${incompleteTasks[0].text}`);
    } else {
      this.currentTask = "æš‚æ— ä»»åŠ¡ï¼Œè¯·æ·»åŠ æ–°ä»»åŠ¡";
      this.pomodoroTimer.setCurrentTask("æš‚æ— ä»»åŠ¡ï¼Œè¯·æ·»åŠ æ–°ä»»åŠ¡");
      console.warn('FocusProgressPage: No tasks available');
    }
  }

  private initializeTimer() {
    // åˆå§‹åŒ–è®¡æ—¶å™¨çŠ¶æ€
    this.timerValue = this.pomodoroTimer.getRemainingTime();
    this.currentTimerState = this.pomodoroTimer.getCurrentState();
    this.isPaused = this.pomodoroTimer.isPausedState();
    this.currentProgress = this.pomodoroTimer.getProgress();
    this.currentTask = this.pomodoroTimer.getCurrentTask();

    // å¦‚æœè®¡æ—¶å™¨æœªè¿è¡Œï¼Œå¼€å§‹ä¸“æ³¨
    if (this.currentTimerState === PomodoroState.IDLE) {
      this.pomodoroTimer.startFocus();
      this.currentTimerState = PomodoroState.FOCUSING;
    }

    // è®¾ç½®äº‹ä»¶å›è°ƒ
    this.pomodoroTimer.setEventCallbacks({
      onTimerTick: (remainingTime: number, totalTime: number) => {
        this.timerValue = remainingTime;
        this.currentProgress = this.pomodoroTimer.getProgress();
        // åŒæ­¥æš‚åœçŠ¶æ€
        this.isPaused = this.pomodoroTimer.isPausedState();
      },
      onStateChange: (newState: PomodoroState) => {
        this.currentTimerState = newState;
        this.timerValue = this.pomodoroTimer.getRemainingTime();
        this.currentProgress = 0;
        this.isPaused = false; // çŠ¶æ€å˜åŒ–æ—¶é‡ç½®æš‚åœçŠ¶æ€

        // çŠ¶æ€å˜åŒ–æ—¶ä¿æŒå½“å‰ä»»åŠ¡ä¸å˜
        // ä¸è‡ªåŠ¨åˆ‡æ¢ä»»åŠ¡ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©è¦ä¸“æ³¨çš„ä»»åŠ¡
      },
      onPomodoroComplete: (type: 'focus' | 'break') => {
        if (type === 'focus') {
          // ä¸“æ³¨å®Œæˆï¼Œæ˜¾ç¤ºå®Œæˆæç¤º
          console.info('ä¸“æ³¨æ—¶é—´å®Œæˆï¼');

          // ä¸“æ³¨å®Œæˆåä¸è‡ªåŠ¨æ ‡è®°ä»»åŠ¡å®Œæˆï¼Œä¿æŒä»»åŠ¡æŒä¹…åŒ–
          // ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨é€‰æ‹©å®Œæˆå“ªäº›ä»»åŠ¡
        }
        // å®Œæˆæ—¶é‡ç½®æš‚åœçŠ¶æ€
        this.isPaused = false;
      }
    });

    this.isPaused = this.pomodoroTimer.isPausedState();
  }

  // æ ¼å¼åŒ–æ—¶é—´ MM:SS
  formatTime(seconds: number): string {
    return PomodoroTimerService.formatTime(seconds);
  }

  // æš‚åœ/ç»§ç»­
  togglePause() {
    if (this.isPaused) {
      this.pomodoroTimer.resume();
    } else {
      this.pomodoroTimer.pause();
    }
    this.isPaused = !this.isPaused;
  }

  // æ”¾å¼ƒ
  abandonFocus() {
    try {
      // ä½¿ç”¨abandonæ–¹æ³•æ”¾å¼ƒå½“å‰ä¸“æ³¨ï¼Œä¸è®°å½•ä¸ºå®Œæˆ
      this.pomodoroTimer.abandon();
      console.info('FocusProgressPage: User abandoned focus session, no completion recorded');
      // ä½¿ç”¨replaceUrlå›åˆ°ä¸»é¡µï¼Œé¿å…ç”¨æˆ·é€šè¿‡è¿”å›é”®å›åˆ°ä¸“æ³¨é¡µé¢
      router.replaceUrl({ url: 'pages/Index' });
    } catch (error) {
      console.error('æ”¾å¼ƒä¸“æ³¨æ—¶å‡ºé”™:', error);
      // å³ä½¿å‡ºé”™ä¹Ÿè¦ç¡®ä¿ç”¨æˆ·èƒ½å›åˆ°ä¸»é¡µ
      router.replaceUrl({ url: 'pages/Index' });
    }
  }

  // æ˜¾ç¤ºè·³è¿‡ç¡®è®¤å¯¹è¯æ¡†
  showSkipDialog() {
    switch (this.currentTimerState) {
      case PomodoroState.FOCUSING:
        this.skipDialogTitle = 'è·³è¿‡ä¸“æ³¨æ—¶é—´';
        this.skipDialogContent = 'ç¡®å®šè¦è·³è¿‡å½“å‰çš„ä¸“æ³¨æ—¶é—´å—ï¼Ÿ\nè¿™å°†æ ‡è®°å½“å‰ä¸“æ³¨ä¸ºå®Œæˆï¼Œå¹¶è¿›å…¥ä¼‘æ¯æ—¶é—´ã€‚';
        break;
      case PomodoroState.SHORT_BREAK:
        this.skipDialogTitle = 'è·³è¿‡çŸ­ä¼‘æ¯';
        this.skipDialogContent = 'ç¡®å®šè¦è·³è¿‡å½“å‰çš„çŸ­ä¼‘æ¯å—ï¼Ÿ\nè¿™å°†ç›´æ¥è¿›å…¥ä¸‹ä¸€ä¸ªä¸“æ³¨æ—¶é—´ã€‚';
        break;
      case PomodoroState.LONG_BREAK:
        this.skipDialogTitle = 'è·³è¿‡é•¿ä¼‘æ¯';
        this.skipDialogContent = 'ç¡®å®šè¦è·³è¿‡å½“å‰çš„é•¿ä¼‘æ¯å—ï¼Ÿ\nè¿™å°†ç›´æ¥è¿›å…¥ä¸‹ä¸€ä¸ªä¸“æ³¨æ—¶é—´ã€‚';
        break;
      default:
        return;
    }
    this.showSkipConfirmDialog = true;
  }

  // ç¡®è®¤è·³è¿‡
  async confirmSkip() {
    this.showSkipConfirmDialog = false;
    console.info('FocusProgressPage: User confirmed skip');
    try {
      await this.pomodoroTimer.skip();

      // è·³è¿‡åä¿æŒå½“å‰ä»»åŠ¡ä¸å˜
      // ç”¨æˆ·å¯ä»¥åœ¨ä¸»é¡µé¢æ‰‹åŠ¨é€‰æ‹©è¦ä¸“æ³¨çš„ä»»åŠ¡

      console.info('FocusProgressPage: Skip completed successfully');
    } catch (error) {
      console.error('FocusProgressPage: Skip failed', error);
    }
  }

  // å–æ¶ˆè·³è¿‡
  cancelSkip() {
    this.showSkipConfirmDialog = false;
    console.info('FocusProgressPage: User cancelled skip');
  }

  // è·³è¿‡å½“å‰é˜¶æ®µ
  async skipCurrentPhase() {
    this.showSkipDialog();
  }

  // è·å–å½“å‰çŠ¶æ€æ–‡æœ¬
  getCurrentStateText(): string {
    switch (this.currentTimerState) {
      case PomodoroState.FOCUSING:
        return 'ä¸“æ³¨æ—¶é—´';
      case PomodoroState.SHORT_BREAK:
        return 'çŸ­ä¼‘æ¯æ—¶é—´';
      case PomodoroState.LONG_BREAK:
        return 'é•¿ä¼‘æ¯æ—¶é—´';
      default:
        return 'å‡†å¤‡å¼€å§‹';
    }
  }

  // è·å–å½“å‰çŠ¶æ€é¢œè‰²
  getCurrentStateColor(): string {
    switch (this.currentTimerState) {
      case PomodoroState.FOCUSING:
        return '#FF6B6B';
      case PomodoroState.SHORT_BREAK:
        return '#4ECDC4';
      case PomodoroState.LONG_BREAK:
        return '#45B7D1';
      default:
        return '#007DFF';
    }
  }

  build() {
    Column() {
      // çŠ¶æ€æŒ‡ç¤ºå™¨
      Text(this.getCurrentStateText())
        .fontSize(18)
        .fontColor(this.getCurrentStateColor())
        .margin({ top: '10%' })

      // è¿›åº¦åœ†ç¯
      Stack({ alignContent: Alignment.Center }) {
        // èƒŒæ™¯åœ†ç¯
        Progress({ value: 100, type: ProgressType.Ring })
          .width(220)
          .style({ strokeWidth: 15 })
          .color('#1F3C53')

        // è¿›åº¦åœ†ç¯
        Progress({ value: this.currentProgress, total: 100, type: ProgressType.Ring })
          .width(220)
          .style({ strokeWidth: 15 })
          .color(this.getCurrentStateColor())

        // æ—¶é—´æ˜¾ç¤º
        Text(this.formatTime(this.timerValue))
          .fontSize(60)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
      }
      .margin({ top: 30, bottom: 30 })

      // å½“å‰ä»»åŠ¡
      Column() {
        Text('å½“å‰ä»»åŠ¡')
          .fontSize(14)
          .fontColor(Color.Gray)

        Text(this.currentTask)
          .fontSize(18)
          .fontColor(Color.White)
          .margin({ top: 5 })
      }
      .margin({ bottom: '15%' })

      // ç¯å¢ƒéŸ³æ•ˆï¼ˆæš‚ä¸å®ç°ï¼‰
      Row() {
        Text('ğŸŒ§ï¸ é›¨å£°')
          .fontColor(Color.White).fontSize(14).margin({right:15})
        Text('ğŸ’¨ é£å£°')
          .fontColor(Color.White).fontSize(14).margin({right:15})
        Text('â˜•ï¸ å’–å•¡é¦†')
          .fontColor(Color.White).fontSize(14)
      }
      .margin({ bottom: 40 })

      // æ§åˆ¶æŒ‰é’®
      Row() {
        Button('æ”¾å¼ƒ', { type: ButtonType.Capsule, stateEffect: true })
          .width('25%')
          .height(50)
          .fontSize(14)
          .backgroundColor('#252525')
          .onClick(() => this.abandonFocus())

        Button('è·³è¿‡', { type: ButtonType.Capsule, stateEffect: true })
          .width('25%')
          .height(50)
          .fontSize(14)
          .backgroundColor('#333333')
          .onClick(() => this.skipCurrentPhase())

        Button(this.isPaused ? 'ç»§ç»­' : 'æš‚åœ', { type: ButtonType.Capsule, stateEffect: true })
          .width('45%')
          .height(50)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .backgroundColor(this.getCurrentStateColor())
          .onClick(() => this.togglePause())
      }
      .width('90%')
      .justifyContent(FlexAlign.SpaceBetween)

      // è·³è¿‡ç¡®è®¤å¯¹è¯æ¡†
    if (this.showSkipConfirmDialog) {
      Stack({ alignContent: Alignment.Center }) {
        // åŠé€æ˜èƒŒæ™¯é®ç½©
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.5)')
          .onClick(() => this.cancelSkip())

        // å¯¹è¯æ¡†å†…å®¹
        Column() {
          Text(this.skipDialogTitle)
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .margin({ bottom: 20 })

          Text(this.skipDialogContent)
            .fontSize(16)
            .fontColor('#E0E0E0')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 30 })

          // æŒ‰é’®
          Row() {
            Button('å–æ¶ˆ', { type: ButtonType.Capsule })
              .width('45%')
              .height(45)
              .fontSize(16)
              .backgroundColor('#666666')
              .onClick(() => this.cancelSkip())

            Button('ç¡®å®š', { type: ButtonType.Capsule })
              .width('45%')
              .height(45)
              .fontSize(16)
              .backgroundColor(this.getCurrentStateColor())
              .onClick(() => this.confirmSkip())
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
        }
        .width('80%')
        .padding(24)
        .backgroundColor('#2C2C2C')
        .borderRadius(12)
      }
      .width('100%')
      .height('100%')
      .position({ x: 0, y: 0 }) // ä½¿ç”¨ç»å¯¹å®šä½ç¡®ä¿å¯¹è¯æ¡†è¦†ç›–æ•´ä¸ªå±å¹•
      .zIndex(1000) // ç¡®ä¿å¯¹è¯æ¡†åœ¨æœ€ä¸Šå±‚
    }
  }
    .width('100%')
    .height('100%')
    .backgroundColor('#1C1C1C')
    .alignItems(HorizontalAlign.Center)
  }
}