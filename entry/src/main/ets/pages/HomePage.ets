import router from '@ohos.router';
import { PomodoroTimerService, PomodoroState } from '../utils/pomodoroTimerService';
import { getStorageInstance } from '../utils/preferencesStorage';
import { TaskManager, Task } from '../utils/taskManager';
import { handleStorageError, handleValidationError, showSuccess } from '../utils/errorService';
import { fileDataParser, ParsedData } from '../utils/fileDataParser';
import { dataVisualizationService } from '../utils/dataVisualizationService';
import common from '@ohos.app.ability.common';

// ä»»åŠ¡æ•°æ®æ¥å£
interface TaskData {
  id: number;
  text: string;
  completed: boolean;
}

@Component
export struct HomePage {
  private pomodoroTimer: PomodoroTimerService = PomodoroTimerService.getInstance();
  private taskManager: TaskManager = TaskManager.getInstance();

  @State timerValue: number = 25 * 60; // 25åˆ†é’Ÿçš„ç§’æ•°
  @State pomodoroTarget: number = 8;
  @State pomodoroCompleted: number = 0;
  @State currentProgress: number = 0;
  @State isTimerRunning: boolean = false;
  @State currentTimerState: PomodoroState = PomodoroState.IDLE;

  @State tasks: Task[] = [];
  @State newTaskText: string = '';
  @State selectedTaskId: number = -1; // å½“å‰é€‰ä¸­çš„ä»»åŠ¡ID

  // æ•°æ®å¯è§†åŒ–ç›¸å…³çŠ¶æ€
  @State isProcessingFile: boolean = false;
  @State lastParsedData: ParsedData | null = null;

  aboutToAppear() {
    // è®¾ç½®å­˜å‚¨Context
    const context = getContext(this) as common.UIAbilityContext;
    getStorageInstance().setContext(context);

    // è®¾ç½®é€šçŸ¥æœåŠ¡Context
    this.pomodoroTimer.getNotificationService().setContext(context);

    this.initializeTimer();
    this.initializeTasks();
    this.setupPomodoroCallbacks();
  }

  private async initializeTasks(): Promise<void> {
    try {
      await this.taskManager.initialize();
      this.tasks = this.taskManager.getTasks();

      // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæœªå®Œæˆçš„ä»»åŠ¡
      const firstIncompleteTask = this.tasks.find(task => !task.completed);
      if (firstIncompleteTask) {
        this.selectedTaskId = firstIncompleteTask.id;
      }
    } catch (error) {
      handleStorageError(error, 'HomePageåˆå§‹åŒ–ä»»åŠ¡');
      // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä»»åŠ¡
      this.tasks = [
        new Task(1, 'è®¾è®¡ç•ªèŒ„é’Ÿç•Œé¢', false),
        new Task(2, 'å‡†å¤‡å‘¨ä¼šæ¼”ç¤ºæ–‡ç¨¿', true)
      ];
      // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæœªå®Œæˆçš„é»˜è®¤ä»»åŠ¡
      this.selectedTaskId = 1;
    }
  }

  aboutToDisappear() {
    try {
      // ç¡®ä¿å®šæ—¶å™¨è¢«æ­£ç¡®æ¸…ç†
      if (this.pomodoroTimer.isTimerActive()) {
        console.warn('HomePage: Timer is still active, cleaning up');
      }
      this.pomodoroTimer.destroy();
      console.info('HomePage: About to disappear, resources cleaned up');
    } catch (error) {
      console.error('HomePage: Error during cleanup', error);
      // å³ä½¿å‡ºé”™ä¹Ÿè¦å¼ºåˆ¶æ¸…ç†
      try {
        this.pomodoroTimer.forceCleanup();
      } catch (cleanupError) {
        console.error('HomePage: Force cleanup failed', cleanupError);
      }
    }
  }

  private initializeTimer() {
    // åˆå§‹åŒ–è®¡æ—¶å™¨çŠ¶æ€
    const stats = this.pomodoroTimer.getStats();
    this.pomodoroCompleted = stats.completedToday;
    this.timerValue = this.pomodoroTimer.getRemainingTime();

    // æ£€æŸ¥å½“å‰çŠ¶æ€
    this.currentTimerState = this.pomodoroTimer.getCurrentState();
    this.isTimerRunning = this.pomodoroTimer.isRunning();
    this.currentProgress = this.pomodoroTimer.getProgress();
  }

  private setupPomodoroCallbacks() {
    // è®¾ç½®äº‹ä»¶å›è°ƒ
    this.pomodoroTimer.setEventCallbacks({
      onTimerTick: (remainingTime: number, totalTime: number) => {
        this.timerValue = remainingTime;
        this.currentProgress = this.pomodoroTimer.getProgress();
      },
      onStateChange: (newState: PomodoroState) => {
        this.currentTimerState = newState;
        this.isTimerRunning = this.pomodoroTimer.isRunning();
      },
      onSessionComplete: () => {
        // ç•ªèŒ„é’Ÿå®Œæˆåï¼Œè‡ªåŠ¨é€‰æ‹©ä¸‹ä¸€ä¸ªä»»åŠ¡
        this.handlePomodoroComplete();
      }
    });
  }

  private handlePomodoroComplete() {
    // æ›´æ–°å®Œæˆè®¡æ•°
    const stats = this.pomodoroTimer.getStats();
    this.pomodoroCompleted = stats.completedToday;

    // è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæœªå®Œæˆçš„ä»»åŠ¡
    const nextTask = this.tasks.find(task => !task.completed);
    if (nextTask) {
      this.selectedTaskId = nextTask.id;
      console.info(`ä¸“æ³¨å®Œæˆï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡: ${nextTask.text}`);
    } else {
      this.selectedTaskId = -1;
      console.info('æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼Œæ¸…é™¤ä»»åŠ¡é€‰æ‹©');
    }
  }

  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
  private formatTime(seconds: number): string {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
  }

  // é‡ç½®è®¡æ—¶å™¨
  private resetTimer() {
    try {
      this.pomodoroTimer.reset();
      this.timerValue = this.pomodoroTimer.getRemainingTime();
      this.currentProgress = 0;
      this.currentTimerState = PomodoroState.IDLE;
      this.isTimerRunning = false;
    } catch (error) {
      console.error('é‡ç½®è®¡æ—¶å™¨å¤±è´¥:', error);
    }
  }

  // å¼€å§‹æˆ–æš‚åœè®¡æ—¶å™¨
  private toggleTimer() {
    try {
      if (this.isTimerRunning) {
        this.pomodoroTimer.pause();
      } else {
        // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„ä»»åŠ¡
        if (this.selectedTaskId === -1) {
          const firstIncompleteTask = this.tasks.find(task => !task.completed);
          if (firstIncompleteTask) {
            this.selectedTaskId = firstIncompleteTask.id;
            console.info(`è‡ªåŠ¨é€‰æ‹©ä»»åŠ¡: ${firstIncompleteTask.text}`);
          } else {
            console.warn('æ²¡æœ‰å¯ä¸“æ³¨çš„ä»»åŠ¡');
            return;
          }
        }

        const selectedTaskText = this.tasks.find(task => task.id === this.selectedTaskId)?.text || 'æœªçŸ¥ä»»åŠ¡';
        this.pomodoroTimer.startFocus();
        console.info(`å¼€å§‹ä¸“æ³¨ä»»åŠ¡: ${selectedTaskText} (ID: ${this.selectedTaskId})`);
      }
    } catch (error) {
      console.error('è®¡æ—¶å™¨æ“ä½œå¤±è´¥:', error);
    }
  }

  // æ·»åŠ ä»»åŠ¡
  private async addTask() {
    const trimmedText = this.newTaskText.trim();
    if (!trimmedText) {
      handleValidationError('ä»»åŠ¡å†…å®¹ä¸èƒ½ä¸ºç©º');
      return;
    }

    try {
      const success = await this.taskManager.addTask(trimmedText);
      if (success) {
        this.newTaskText = '';
        this.tasks = this.taskManager.getTasks();
        showSuccess('ä»»åŠ¡æ·»åŠ æˆåŠŸ');

        // å¦‚æœè¿™æ˜¯ç¬¬ä¸€ä¸ªæœªå®Œæˆçš„ä»»åŠ¡ä¸”å½“å‰æ²¡æœ‰é€‰ä¸­ä»»åŠ¡ï¼Œè‡ªåŠ¨é€‰æ‹©å®ƒ
        if (this.selectedTaskId === -1) {
          const firstIncompleteTask = this.tasks.find(task => !task.completed);
          if (firstIncompleteTask) {
            this.selectedTaskId = firstIncompleteTask.id;
          }
        }
      }
    } catch (error) {
      handleStorageError(error, 'æ·»åŠ ä»»åŠ¡');
    }
  }

  // åˆ é™¤ä»»åŠ¡
  private async deleteTask(taskId: number) {
    try {
      const success = await this.taskManager.deleteTask(taskId);
      if (success) {
        this.tasks = this.taskManager.getTasks();
        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„ä»»åŠ¡ï¼Œæ¸…é™¤é€‰æ‹©
        if (taskId === this.selectedTaskId) {
          this.selectedTaskId = -1;
          // è‡ªåŠ¨é€‰æ‹©å¦ä¸€ä¸ªæœªå®Œæˆçš„ä»»åŠ¡
          const firstIncompleteTask = this.tasks.find(task => !task.completed);
          if (firstIncompleteTask) {
            this.selectedTaskId = firstIncompleteTask.id;
          }
        }
        showSuccess('ä»»åŠ¡åˆ é™¤æˆåŠŸ');
      }
    } catch (error) {
      handleStorageError(error, 'åˆ é™¤ä»»åŠ¡');
    }
  }

  // é€‰æ‹©ä»»åŠ¡
  private selectTask(taskId: number) {
    this.selectedTaskId = taskId;
    console.info(`é€‰æ‹©ä»»åŠ¡ID: ${taskId}`);
  }

  // ä»»åŠ¡å®ŒæˆçŠ¶æ€åˆ‡æ¢
  private async toggleTaskComplete(taskId: number) {
    try {
      const success = await this.taskManager.toggleTaskComplete(taskId);
      if (success) {
        this.tasks = this.taskManager.getTasks(); // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
        // å¦‚æœé€‰æ‹©çš„ä»»åŠ¡è¢«å®Œæˆäº†ï¼Œæ¸…é™¤é€‰æ‹©
        if (taskId === this.selectedTaskId) {
          this.selectedTaskId = -1;
          // è‡ªåŠ¨é€‰æ‹©ä¸‹ä¸€ä¸ªæœªå®Œæˆçš„ä»»åŠ¡
          const firstIncompleteTask = this.tasks.find(task => !task.completed);
          if (firstIncompleteTask) {
            this.selectedTaskId = firstIncompleteTask.id;
          }
        }
      }
    } catch (error) {
      console.error('åˆ‡æ¢ä»»åŠ¡å®ŒæˆçŠ¶æ€å¤±è´¥:', error);
    }
  }

  // é€‰æ‹©å¹¶è§£ææ•°æ®æ–‡ä»¶
  private async selectAndParseDataFile() {
    if (this.isProcessingFile) {
      return;
    }

    this.isProcessingFile = true;

    try {
      // é€‰æ‹©å¹¶è§£ææ–‡ä»¶
      const parsedData = await fileDataParser.selectAndParseFile();

      // éªŒè¯è§£æç»“æœ
      const validation = fileDataParser.validateParsedData(parsedData);
      if (!validation.isValid) {
        handleValidationError('æ–‡ä»¶è§£æå¤±è´¥:\n' + validation.errors.join('\n'));
        return;
      }

      // ä¿å­˜è§£æç»“æœ
      this.lastParsedData = parsedData;
      showSuccess(`æˆåŠŸè§£ææ–‡ä»¶: ${parsedData.fileName}\næ•°æ®è¡Œæ•°: ${parsedData.rowCount}, åˆ—æ•°: ${parsedData.columnCount}`);

      // è·³è½¬åˆ°å›¾è¡¨ç±»å‹é€‰æ‹©é¡µé¢
      router.pushUrl({
        url: 'pages/ChartTypeSelectorPage',
        params: {
          parsedData: parsedData
        }
      });

    } catch (error) {
      console.error('[HomePage] æ–‡ä»¶å¤„ç†å¤±è´¥:', error);
      handleValidationError('æ–‡ä»¶å¤„ç†å¤±è´¥: ' + (error as Error).message);
    } finally {
      this.isProcessingFile = false;
    }
  }

  build() {
    Scroll() {
      Column() {
        // é¡¶éƒ¨æ ‡é¢˜æ 
        Row() {
          Text('ç•ªèŒ„åŠ©æ‰‹')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .layoutWeight(1)

          Button('è®¾ç½®')
            .fontSize(16)
            .fontColor('#007DFF')
            .backgroundColor('transparent')
            .onClick(() => {
              router.pushUrl({ url: 'pages/SettingsPage' });
            })
        }
        .width('100%')
        .padding({ top: 20, bottom: 40 })

        // ä¸»è®¡æ—¶å™¨å¡ç‰‡
        Column() {
          Stack({ alignContent: Alignment.Center }) {
            Progress({ value: 100, type: ProgressType.Ring })
              .width(200)
              .height(200)
              .style({ strokeWidth: 20 })
              .color('#333333')

            Progress({ value: this.currentProgress, total: 100, type: ProgressType.Ring })
              .width(200)
              .height(200)
              .style({ strokeWidth: 20 })
              .color('#007DFF')

            Column() {
              Text(this.formatTime(this.timerValue))
                .fontSize(40)
                .fontWeight(FontWeight.Bold)
                .fontColor(Color.White)

              Text(this.currentTimerState === PomodoroState.FOCUSING ? 'ä¸“æ³¨ä¸­' : 'ä¼‘æ¯ä¸­')
                .fontSize(16)
                .fontColor('#CCCCCC')
                .margin({ top: 5 })
            }
          }
          .margin({ bottom: 50 })

          // æ§åˆ¶æŒ‰é’®
          Row() {
            Button('é‡ç½®', { type: ButtonType.Capsule, stateEffect: true })
              .width(80)
              .height(40)
              .fontSize(14)
              .backgroundColor('#666666')
              .onClick(() => this.resetTimer())

            Button(this.isTimerRunning ? 'æš‚åœ' : (this.currentTimerState === PomodoroState.IDLE ? 'å¼€å§‹' : 'ç»§ç»­'), { type: ButtonType.Capsule, stateEffect: true })
              .width(80)
              .height(40)
              .fontSize(14)
              .backgroundColor(this.isTimerRunning ? '#FF6B6B' : '#4CAF50')
              .margin({ left: 20, right: 20 })
              .onClick(() => this.toggleTimer())

            Button('ä¸“æ³¨', { type: ButtonType.Capsule, stateEffect: true })
              .width(80)
              .height(40)
              .fontSize(14)
              .backgroundColor('#007DFF')
              .onClick(() => {
                if (this.selectedTaskId === -1) {
                  const firstIncompleteTask = this.tasks.find(task => !task.completed);
                  if (firstIncompleteTask) {
                    this.selectedTaskId = firstIncompleteTask.id;
                  }
                }

                const selectedTask = this.tasks.find(task => task.id === this.selectedTaskId);
                if (selectedTask) {
                  const taskData: TaskData = { id: selectedTask.id, text: selectedTask.text, completed: selectedTask.completed };
                  console.info(`å¼€å§‹ä¸“æ³¨ä»»åŠ¡: ${selectedTask.text} (ID: ${this.selectedTaskId})`);

                  router.pushUrl({
                    url: 'pages/FocusProgressPage',
                    params: {
                      taskData: taskData,
                      taskId: this.selectedTaskId
                    }
                  });
                } else {
                  console.warn('æ²¡æœ‰é€‰ä¸­çš„ä»»åŠ¡');
                }
              })
          }
        }
        .margin({ bottom: 40 })

        // ç•ªèŒ„é’Ÿç»Ÿè®¡
        Column() {
          Text('ä»Šæ—¥è¿›åº¦')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 10 })

          Text(`å·²å®Œæˆ ${this.pomodoroCompleted} ä¸ªï¼Œç›®æ ‡ ${this.pomodoroTarget} ä¸ª`)
            .fontSize(16)
            .fontColor('#CCCCCC')
            .margin({ bottom: 15 })

          Stack({ alignContent: Alignment.Center }) {
            Progress({ value: (this.pomodoroCompleted / this.pomodoroTarget) * 100, type: ProgressType.Ring })
              .width(100)
              .height(100)
              .style({ strokeWidth: 8 })
              .color('#007DFF')

            Text(`${this.pomodoroCompleted}/${this.pomodoroTarget}`)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
          }
        }
        .margin({ bottom: 20 })

        // ä»Šæ—¥ä»»åŠ¡è·³è½¬æŒ‰é’®
        Button() {
          Row() {
            Text('ğŸ… ä»Šæ—¥ç•ªèŒ„è®°å½•')
              .fontSize(18)
              .fontColor(Color.White)
              .layoutWeight(1)
            Text('â†’')
              .fontSize(18)
              .fontColor('#007DFF')
          }
          .width('100%')
          .padding({ left: 20, right: 20 })
        }
        .type(ButtonType.Normal)
        .backgroundColor('#2A2A2A')
        .borderRadius(12)
        .height(50)
        .margin({ bottom: 15 })
        .onClick(() => {
          router.pushUrl({ url: 'pages/PomodoroHistoryPage' });
        })

        // æ•°æ®å¯è§†åŒ–å…¥å£æŒ‰é’®
        Button() {
          Row() {
            Text('ğŸ“Š æ•°æ®å¯è§†åŒ–')
              .fontSize(18)
              .fontColor(Color.White)
              .layoutWeight(1)
            if (this.isProcessingFile) {
              LoadingProgress()
                .width(20)
                .height(20)
                .color('#007DFF')
            } else {
              Text('â†’')
                .fontSize(18)
                .fontColor('#007DFF')
            }
          }
          .width('100%')
          .padding({ left: 20, right: 20 })
        }
        .type(ButtonType.Normal)
        .backgroundColor(this.isProcessingFile ? '#333333' : '#2A2A2A')
        .borderRadius(12)
        .height(50)
        .margin({ bottom: 20 })
        .enabled(!this.isProcessingFile)
        .onClick(() => {
          this.selectAndParseDataFile();
        })

        // ä»»åŠ¡ç®¡ç†
        Column() {
          Text('ä»Šæ—¥ä»»åŠ¡')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 15 })

          // ä»»åŠ¡åˆ—è¡¨
          Column() {
            ForEach(this.tasks, (item: Task) => {
              Row() {
                // ä»»åŠ¡é€‰æ‹©å’Œå†…å®¹
                Row() {
                  // é€‰æ‹©æŒ‡ç¤ºå™¨
                  Circle({ width: 8, height: 8 })
                    .fill(this.selectedTaskId === item.id ? '#007DFF' : '#666666')
                    .margin({ right: 10 })

                  // ä»»åŠ¡æ–‡æœ¬
                  Text(item.text)
                    .fontSize(16)
                    .fontColor(item.completed ? '#888888' : Color.White)
                    .decoration({ type: item.completed ? TextDecorationType.LineThrough : TextDecorationType.None })
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .layoutWeight(1)
                    .onClick(() => {
                      // ç‚¹å‡»ä»»åŠ¡æ–‡æœ¬ä¹Ÿå¯ä»¥é€‰æ‹©ä»»åŠ¡
                      if (!item.completed) {
                        this.selectTask(item.id);
                      }
                    })

                  // å®ŒæˆçŠ¶æ€å¤é€‰æ¡†
                  Checkbox({ name: `task_complete_${item.id}`, group: 'task_completion' })
                    .select(item.completed)
                    .selectedColor('#4CAF50')
                    .onChange(async (isSelected: boolean) => {
                      try {
                        const success = await this.taskManager.toggleTaskComplete(item.id);
                        if (success) {
                          this.tasks = this.taskManager.getTasks(); // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                          // å¦‚æœé€‰æ‹©çš„ä»»åŠ¡è¢«å®Œæˆäº†ï¼Œæ¸…é™¤é€‰æ‹©
                          if (item.id === this.selectedTaskId && isSelected) {
                            this.selectedTaskId = -1;
                          }
                        }
                      } catch (error) {
                        console.error('HomePage: Failed to toggle task completion', error);
                      }
                    })

                  // åˆ é™¤æŒ‰é’®
                  Text('Ã—')
                    .fontSize(20)
                    .fontColor(Color.Gray)
                    .margin({ left: 10 })
                    .onClick(() => this.deleteTask(item.id))
                }
                .alignItems(VerticalAlign.Center)
                .width('100%')
                .padding({ top: 8, bottom: 8 })
                .backgroundColor(this.selectedTaskId === item.id ? '#2A2A2A' : 'transparent')
                .borderRadius(8)
                .padding({ left: 8, right: 8 })
              }
            }, (item: Task) => item.id.toString())

            // æ·»åŠ æ–°ä»»åŠ¡
            Row() {
              TextInput({ placeholder: 'æ·»åŠ æ–°ä»»åŠ¡...', text: this.newTaskText })
                .onChange((value: string) => {
                  this.newTaskText = value;
                })
                .onSubmit(() => {
                  this.addTask();
                })
                .layoutWeight(1)
                .height(40)
                .backgroundColor('#333333')
                .fontColor(Color.White)
                .placeholderColor(Color.Gray)
                .borderRadius(20)
                .padding({left:15})

              Button('+')
                .width(40)
                .height(40)
                .fontSize(20)
                .margin({ left: 10 })
                .type(ButtonType.Circle)
                .backgroundColor('#007DFF')
                .onClick(() => this.addTask())
            }
            .width('100%')
            .margin({ top: 20, bottom: 10 })
          }
          .width('100%')
        }
        .width('90%')
        .padding(20)
        .backgroundColor('#252525')
        .borderRadius(15)
      }
      .width('100%')
      .padding({ left: 15, right: 15, bottom: 20 }) // æ·»åŠ åº•éƒ¨å†…è¾¹è·ï¼Œç¡®ä¿å†…å®¹ä¸è¢«åº•éƒ¨å¯¼èˆªæ é®æŒ¡
    }
    .scrollable(ScrollDirection.Vertical)
    .scrollBar(BarState.Off)
    .backgroundColor('#1C1C1C')
    .height('100%')
  }
}