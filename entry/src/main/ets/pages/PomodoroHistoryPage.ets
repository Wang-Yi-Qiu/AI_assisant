/**
 * ç•ªèŒ„é’Ÿå®Œæˆè®°å½•é¡µé¢
 * å±•ç¤ºä»Šæ—¥å®Œæˆçš„ç•ªèŒ„é’Ÿå†å²è®°å½•
 * @module PomodoroHistoryPage
 */

import router from '@ohos.router';
import { PomodoroTimerService, CompletedPomodoro } from '../utils/pomodoroTimerService';

@Entry
@Component
export struct PomodoroHistoryPage {
  private pomodoroTimer: PomodoroTimerService = PomodoroTimerService.getInstance();
  @State completedPomodoros: CompletedPomodoro[] = [];
  @State isLoading: boolean = true;

  aboutToAppear() {
    this.loadTodayCompletedPomodoros();
  }

  private async loadTodayCompletedPomodoros(): Promise<void> {
    try {
      this.completedPomodoros = this.pomodoroTimer.getTodayCompletedPomodoros();
      console.info(`PomodoroHistoryPage: Loaded ${this.completedPomodoros.length} completed pomodoros`);
    } catch (error) {
      console.error('PomodoroHistoryPage: Failed to load completed pomodoros', error);
    } finally {
      this.isLoading = false;
    }
  }

  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
  formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
  }

  // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
  formatDate(timestamp: number): string {
    const date = new Date(timestamp);
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${month}æœˆ${day}æ—¥`;
  }

  // è·å–ç•ªèŒ„é’Ÿå›¾æ ‡
  getPomodoroIcon(index: number): string {
    const icons = ['ğŸ…', 'ğŸ”¥', 'â­', 'ğŸ’ª', 'ğŸ¯', 'ğŸš€', 'âœ¨', 'ğŸŒŸ'];
    return icons[index % icons.length];
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(24)
            .fontColor(Color.White)
        }
        .type(ButtonType.Circle)
        .backgroundColor('transparent')
        .width(40)
        .height(40)
        .onClick(() => {
          router.back();
        })

        Text('ä»Šæ—¥ç•ªèŒ„è®°å½•')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Blank()
          .width(40) // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
      }
      .width('100%')
      .padding({ left: 15, right: 15, top: 20, bottom: 20 })

      if (this.isLoading) {
        LoadingProgress()
          .width(50)
          .height(50)
          .color('#007DFF')
          .margin({ top: 100 })

        Text('åŠ è½½ä¸­...')
          .fontSize(16)
          .fontColor(Color.Gray)
          .margin({ top: 20 })
      } else if (this.completedPomodoros.length === 0) {
        // ç©ºçŠ¶æ€
        Column() {
          Text('ğŸ…')
            .fontSize(80)
            .margin({ bottom: 20 })

          Text('ä»Šæ—¥è¿˜æ²¡æœ‰å®Œæˆç•ªèŒ„é’Ÿ')
            .fontSize(18)
            .fontColor(Color.White)
            .margin({ bottom: 10 })

          Text('å¼€å§‹ä¸“æ³¨ï¼Œå®Œæˆç¬¬ä¸€ä¸ªç•ªèŒ„é’Ÿå§ï¼')
            .fontSize(14)
            .fontColor(Color.Gray)
            .textAlign(TextAlign.Center)
        }
        .width('100%')
        .margin({ top: 100 })
      } else {
        // ç»Ÿè®¡å¡ç‰‡
        this.StatsCard()

        Scroll() {
          Column() {
            Text('å®Œæˆè®°å½•')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
              .alignSelf(ItemAlign.Start)
              .margin({ left: 20, bottom: 15 })

            ForEach(this.completedPomodoros, (item: CompletedPomodoro, index?: number) => {
              this.PomodoroRecordCard(item, index || 0)
            })
          }
          .width('100%')
          .padding({ bottom: 30 })
        }
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Off)
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#1C1C1C')
  }

  @Builder
  StatsCard() {
    Column() {
      Row() {
        Column() {
          Text(this.completedPomodoros.length.toString())
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor('#007DFF')

          Text('å®Œæˆç•ªèŒ„æ•°')
            .fontSize(14)
            .fontColor(Color.Gray)
            .margin({ top: 5 })
        }
        .layoutWeight(1)

        Column() {
          const totalMinutes = this.completedPomodoros.reduce((sum, item) => sum + item.duration, 0);
          Text(totalMinutes.toString())
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor('#4ECDC4')

          Text('ä¸“æ³¨åˆ†é’Ÿ')
            .fontSize(14)
            .fontColor(Color.Gray)
            .margin({ top: 5 })
        }
        .layoutWeight(1)

        Column() {
          const uniqueTasks = new Set(this.completedPomodoros.map(item => item.taskId)).size;
          Text(uniqueTasks.toString())
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B6B')

          Text('æ¶‰åŠä»»åŠ¡')
            .fontSize(14)
            .fontColor(Color.Gray)
            .margin({ top: 5 })
        }
        .layoutWeight(1)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('90%')
    .padding(20)
    .backgroundColor('#252525')
    .borderRadius(15)
    .margin({ bottom: 20 })
  }

  @Builder
  PomodoroRecordCard(record: CompletedPomodoro, index: number) {
    Row() {
      // ç•ªèŒ„é’Ÿå›¾æ ‡
      Text(this.getPomodoroIcon(index))
        .fontSize(32)
        .margin({ right: 15 })

      // å†…å®¹åŒºåŸŸ
      Column() {
        Text(record.taskText)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(Color.White)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .alignSelf(ItemAlign.Start)

        Row() {
          Text(`${record.duration} åˆ†é’Ÿ`)
            .fontSize(14)
            .fontColor('#007DFF')

          Text(' â€¢ ')
            .fontSize(14)
            .fontColor(Color.Gray)

          Text(this.formatTime(record.completedAt))
            .fontSize(14)
            .fontColor(Color.Gray)
        }
        .margin({ top: 5 })
        .alignSelf(ItemAlign.Start)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // å®Œæˆæ ‡è®°
      Column() {
        Text('âœ“')
          .fontSize(16)
          .fontColor(Color.White)

        Text('å®Œæˆ')
          .fontSize(12)
          .fontColor('#4CAF50')
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Center)
    }
    .width('90%')
    .padding(15)
    .backgroundColor('#2A2A2A')
    .borderRadius(12)
    .margin({ bottom: 10, left: 20, right: 20 })
    .alignItems(VerticalAlign.Center)
  }
}